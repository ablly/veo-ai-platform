# ğŸ” è§†é¢‘ç”Ÿæˆé”™è¯¯è¯Šæ–­æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**ç”¨æˆ·åé¦ˆ**: åœ¨é¡¹ç›®é¦–é¡µç”¨ç”¨æˆ·è´¦æˆ·æµ‹è¯•ç”Ÿæˆè§†é¢‘æ—¶æŠ¥é”™

**å½±å“èŒƒå›´**: æ ¸å¿ƒè§†é¢‘ç”ŸæˆåŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨

**ç´§æ€¥ç¨‹åº¦**: ğŸ”´ é«˜ä¼˜å…ˆçº§ - å½±å“æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½

## ğŸ” å¯èƒ½çš„é”™è¯¯åŸå› åˆ†æ

### 1. APIé…ç½®é—®é¢˜ ğŸ”§
**ç—‡çŠ¶**: é€Ÿåˆ›APIå¯†é’¥æœªé…ç½®æˆ–æ— æ•ˆ
**é”™è¯¯ä¿¡æ¯**: `"é€Ÿåˆ›APIå¯†é’¥æœªé…ç½®"` æˆ– `"é€Ÿåˆ›APIé”™è¯¯: 401"`
**æ£€æŸ¥æ–¹æ³•**:
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $SUCHUANG_API_KEY
echo $SUCHUANG_API_URL
```

### 2. ç”¨æˆ·ç§¯åˆ†ä¸è¶³ ğŸ’³
**ç—‡çŠ¶**: ç”¨æˆ·ç§¯åˆ†ä½™é¢å°‘äº15ç§¯åˆ†
**é”™è¯¯ä¿¡æ¯**: `"ç§¯åˆ†ä¸è¶³ï¼Œéœ€è¦ 15 ç§¯åˆ†ï¼Œå½“å‰ä½™é¢ X ç§¯åˆ†"`
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹ç”¨æˆ·ç§¯åˆ†è´¦æˆ·è¡¨

### 3. ç”¨æˆ·å¥—é¤è¿‡æœŸ â°
**ç—‡çŠ¶**: ç”¨æˆ·å¥—é¤å·²è¿‡æœŸæˆ–è¢«æ ‡è®°ä¸ºè¿‡æœŸ
**é”™è¯¯ä¿¡æ¯**: `"æ‚¨çš„å¥—é¤å·²è¿‡æœŸï¼Œè¯·è´­ä¹°æ–°å¥—é¤åç»§ç»­ä½¿ç”¨"`
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹ç”¨æˆ·å¥—é¤è¿‡æœŸæ—¶é—´

### 4. å¤–éƒ¨APIè°ƒç”¨å¤±è´¥ ğŸŒ
**ç—‡çŠ¶**: é€Ÿåˆ›APIæœåŠ¡ä¸å¯ç”¨æˆ–è¿”å›é”™è¯¯
**é”™è¯¯ä¿¡æ¯**: `"é€Ÿåˆ›APIè°ƒç”¨å¤±è´¥"` æˆ–å…·ä½“çš„APIé”™è¯¯
**æ£€æŸ¥æ–¹æ³•**: æµ‹è¯•APIè¿æ¥æ€§

### 5. æ•°æ®åº“è¿æ¥é—®é¢˜ ğŸ—„ï¸
**ç—‡çŠ¶**: ç”¨æˆ·æ•°æ®æŸ¥è¯¢å¤±è´¥æˆ–æ•°æ®åº“è¿æ¥å¼‚å¸¸
**é”™è¯¯ä¿¡æ¯**: `"ç”¨æˆ·ä¸å­˜åœ¨"` æˆ–æ•°æ®åº“è¿æ¥é”™è¯¯
**æ£€æŸ¥æ–¹æ³•**: æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œç”¨æˆ·æ•°æ®

### 6. è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥ âœ…
**ç—‡çŠ¶**: å‰ç«¯å‘é€çš„å‚æ•°ä¸ç¬¦åˆåç«¯éªŒè¯è§„åˆ™
**é”™è¯¯ä¿¡æ¯**: `"ç¼ºå°‘å¿…éœ€å‚æ•°"` æˆ– `"è§†é¢‘æè¿°ä¸èƒ½ä¸ºç©º"`
**æ£€æŸ¥æ–¹æ³•**: æ£€æŸ¥å‰ç«¯å‘é€çš„è¯·æ±‚æ•°æ®

## ğŸ› ï¸ è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥APIé…ç½®
```sql
-- æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­çš„APIé…ç½®
SELECT * FROM system_settings 
WHERE key IN ('suchuang_api_key', 'suchuang_api_url');
```

### æ­¥éª¤2: æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
```sql
-- æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†å’Œå¥—é¤çŠ¶æ€
SELECT 
  u.id, u.email, u.name,
  COALESCE(uca.available_credits, 0) as available_credits,
  uca.package_expires_at,
  uca.is_expired,
  uca.package_name
FROM users u 
LEFT JOIN user_credit_accounts uca ON u.id = uca.user_id 
WHERE u.email = 'ç”¨æˆ·é‚®ç®±';
```

### æ­¥éª¤3: æ£€æŸ¥æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
```sql
-- æŸ¥çœ‹æœ€è¿‘çš„è§†é¢‘ç”Ÿæˆè®°å½•
SELECT * FROM video_generations 
WHERE created_at >= NOW() - INTERVAL '1 hour'
ORDER BY created_at DESC 
LIMIT 10;
```

### æ­¥éª¤4: æµ‹è¯•APIè¿æ¥
- ä½¿ç”¨ç®¡ç†åå°çš„APIæµ‹è¯•åŠŸèƒ½
- æ£€æŸ¥é€Ÿåˆ›APIçš„å¯ç”¨æ€§å’Œå“åº”

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: APIé…ç½®ä¿®å¤
```typescript
// ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®è®¾ç½®
SUCHUANG_API_KEY=your_actual_api_key
SUCHUANG_API_URL=https://api.wuyinkeji.com

// æˆ–åœ¨ç³»ç»Ÿè®¾ç½®ä¸­é…ç½®
INSERT INTO system_settings (key, value, description) VALUES
('suchuang_api_key', 'your_api_key', 'é€Ÿåˆ›APIå¯†é’¥'),
('suchuang_api_url', 'https://api.wuyinkeji.com', 'é€Ÿåˆ›APIåœ°å€');
```

### æ–¹æ¡ˆ2: ç”¨æˆ·ç§¯åˆ†ä¿®å¤
```sql
-- ä¸ºæµ‹è¯•ç”¨æˆ·æ·»åŠ ç§¯åˆ†
INSERT INTO user_credit_accounts (
  user_id, available_credits, total_credits, used_credits, frozen_credits
) VALUES (
  'user_id', 100, 100, 0, 0
) ON CONFLICT (user_id) DO UPDATE SET
  available_credits = 100,
  total_credits = 100,
  updated_at = NOW();
```

### æ–¹æ¡ˆ3: å¥—é¤è¿‡æœŸä¿®å¤
```sql
-- å»¶é•¿ç”¨æˆ·å¥—é¤æœ‰æ•ˆæœŸ
UPDATE user_credit_accounts 
SET 
  package_expires_at = NOW() + INTERVAL '90 days',
  is_expired = false,
  package_name = 'æµ‹è¯•å¥—é¤',
  updated_at = NOW()
WHERE user_id = 'user_id';
```

### æ–¹æ¡ˆ4: é”™è¯¯å¤„ç†å¢å¼º
```typescript
// åœ¨è§†é¢‘ç”ŸæˆAPIä¸­æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
logger.error("è§†é¢‘ç”Ÿæˆè¯¦ç»†é”™è¯¯", {
  user_email: session.user.email,
  error_type: error.constructor.name,
  error_message: error.message,
  error_stack: error.stack,
  request_body: body,
  timestamp: new Date().toISOString()
})
```

## ğŸš¨ ç´§æ€¥ä¿®å¤å»ºè®®

### ç«‹å³æ‰§è¡Œçš„ä¿®å¤æ­¥éª¤:

1. **æ£€æŸ¥APIå¯†é’¥é…ç½®**:
   - ç¡®è®¤ç³»ç»Ÿè®¾ç½®ä¸­çš„é€Ÿåˆ›APIå¯†é’¥æ˜¯å¦æ­£ç¡®
   - ä½¿ç”¨ç®¡ç†åå°æµ‹è¯•APIè¿æ¥

2. **ä¸ºæµ‹è¯•ç”¨æˆ·æ·»åŠ ç§¯åˆ†**:
   ```sql
   -- å¿«é€Ÿä¸ºæµ‹è¯•ç”¨æˆ·æ·»åŠ ç§¯åˆ†
   UPDATE user_credit_accounts 
   SET available_credits = 100 
   WHERE user_id IN (
     SELECT id FROM users WHERE email = 'æµ‹è¯•ç”¨æˆ·é‚®ç®±'
   );
   ```

3. **æ£€æŸ¥ç”¨æˆ·å¥—é¤çŠ¶æ€**:
   ```sql
   -- ç¡®ä¿æµ‹è¯•ç”¨æˆ·å¥—é¤æœªè¿‡æœŸ
   UPDATE user_credit_accounts 
   SET is_expired = false,
       package_expires_at = NOW() + INTERVAL '30 days'
   WHERE user_id IN (
     SELECT id FROM users WHERE email = 'æµ‹è¯•ç”¨æˆ·é‚®ç®±'
   );
   ```

4. **å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•**:
   - ä¸´æ—¶å¢åŠ è§†é¢‘ç”ŸæˆAPIçš„æ—¥å¿—çº§åˆ«
   - è®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”æ•°æ®

## ğŸ“Š ç›‘æ§å’Œé¢„é˜²

### å®æ—¶ç›‘æ§æŒ‡æ ‡:
- APIè°ƒç”¨æˆåŠŸç‡
- ç”¨æˆ·ç§¯åˆ†ä½™é¢åˆ†å¸ƒ
- å¥—é¤è¿‡æœŸæé†’
- é”™è¯¯æ—¥å¿—ç»Ÿè®¡

### é¢„é˜²æªæ–½:
1. **APIå¥åº·æ£€æŸ¥**: å®šæœŸæµ‹è¯•å¤–éƒ¨APIå¯ç”¨æ€§
2. **ç§¯åˆ†é¢„è­¦**: ç”¨æˆ·ç§¯åˆ†ä½äºé˜ˆå€¼æ—¶è‡ªåŠ¨æé†’
3. **å¥—é¤åˆ°æœŸæé†’**: æå‰7å¤©å‘é€è¿‡æœŸæé†’
4. **é”™è¯¯ç›‘æ§**: å®æ—¶ç›‘æ§é”™è¯¯ç‡å’Œå¼‚å¸¸æ¨¡å¼

## ğŸ¯ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### é”™è¯¯æç¤ºä¼˜åŒ–:
```typescript
// ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
const ERROR_MESSAGES = {
  INSUFFICIENT_CREDITS: "ç§¯åˆ†ä¸è¶³ï¼Œè¯·å‰å¾€å……å€¼é¡µé¢è´­ä¹°ç§¯åˆ†åŒ…",
  PACKAGE_EXPIRED: "æ‚¨çš„å¥—é¤å·²è¿‡æœŸï¼Œè¯·ç»­è´¹åç»§ç»­ä½¿ç”¨",
  API_ERROR: "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ",
  VALIDATION_ERROR: "è¯·æ£€æŸ¥è¾“å…¥å†…å®¹æ˜¯å¦ç¬¦åˆè¦æ±‚"
}
```

### å‰ç«¯é”™è¯¯å¤„ç†:
```typescript
// åœ¨é¦–é¡µæ·»åŠ æ›´å¥½çš„é”™è¯¯å¤„ç†
catch (error) {
  console.error("ç”Ÿæˆå¤±è´¥:", error)
  
  // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
  if (error.message.includes("ç§¯åˆ†ä¸è¶³")) {
    // æ˜¾ç¤ºå……å€¼å¼•å¯¼
    showCreditsPurchaseModal()
  } else if (error.message.includes("è¿‡æœŸ")) {
    // æ˜¾ç¤ºç»­è´¹å¼•å¯¼
    showRenewalModal()
  } else {
    // æ˜¾ç¤ºé€šç”¨é”™è¯¯æç¤º
    alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
  }
}
```

## ğŸ” è°ƒè¯•å·¥å…·

### 1. APIæµ‹è¯•å·¥å…·
```bash
# ç›´æ¥æµ‹è¯•é€Ÿåˆ›API
curl -X POST "https://api.wuyinkeji.com/api/video/veoPlus" \
  -H "Content-Type: application/json" \
  -H "Authorization: YOUR_API_KEY" \
  -d '{
    "model": "veo3",
    "prompt": "æµ‹è¯•è§†é¢‘ç”Ÿæˆ",
    "type": "text2video",
    "ratio": "16:9"
  }'
```

### 2. æ•°æ®åº“æŸ¥è¯¢å·¥å…·
```sql
-- å®Œæ•´çš„ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
SELECT 
  u.id, u.email, u.name, u.created_at,
  uca.available_credits, uca.total_credits, uca.used_credits,
  uca.package_name, uca.package_expires_at, uca.is_expired,
  COUNT(vg.id) as total_videos,
  COUNT(CASE WHEN vg.status = 'COMPLETED' THEN 1 END) as completed_videos,
  COUNT(CASE WHEN vg.status = 'FAILED' THEN 1 END) as failed_videos
FROM users u
LEFT JOIN user_credit_accounts uca ON u.id = uca.user_id
LEFT JOIN video_generations vg ON u.id = vg.user_id
WHERE u.email = 'æµ‹è¯•ç”¨æˆ·é‚®ç®±'
GROUP BY u.id, uca.user_id;
```

### 3. æ—¥å¿—åˆ†æå·¥å…·
```bash
# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
tail -f logs/application.log | grep "è§†é¢‘ç”Ÿæˆå¤±è´¥"

# ç»Ÿè®¡é”™è¯¯ç±»å‹
grep "è§†é¢‘ç”Ÿæˆå¤±è´¥" logs/application.log | \
  jq -r '.error_type' | sort | uniq -c
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### ç³»ç»Ÿé…ç½®æ£€æŸ¥:
- [ ] é€Ÿåˆ›APIå¯†é’¥å·²é…ç½®ä¸”æœ‰æ•ˆ
- [ ] é€Ÿåˆ›APIåœ°å€æ­£ç¡®
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®

### ç”¨æˆ·æ•°æ®æ£€æŸ¥:
- [ ] æµ‹è¯•ç”¨æˆ·å­˜åœ¨ä¸”çŠ¶æ€æ­£å¸¸
- [ ] ç”¨æˆ·æœ‰è¶³å¤Ÿçš„ç§¯åˆ†ä½™é¢
- [ ] ç”¨æˆ·å¥—é¤æœªè¿‡æœŸ
- [ ] ç”¨æˆ·æƒé™è®¾ç½®æ­£ç¡®

### åŠŸèƒ½æµ‹è¯•æ£€æŸ¥:
- [ ] å‰ç«¯è¡¨å•éªŒè¯æ­£å¸¸
- [ ] APIè¯·æ±‚æ ¼å¼æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å·¥ä½œ
- [ ] æ—¥å¿—è®°å½•å®Œæ•´

---

**ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. ç«‹å³æ£€æŸ¥APIé…ç½®å’Œç”¨æˆ·ç§¯åˆ†çŠ¶æ€
2. æ‰§è¡Œç´§æ€¥ä¿®å¤æ–¹æ¡ˆ
3. è¿›è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
4. ä¼˜åŒ–é”™è¯¯æç¤ºå’Œç”¨æˆ·ä½“éªŒ

**ğŸ“ å¦‚éœ€æ”¯æŒ**: è¯·æä¾›å…·ä½“çš„é”™è¯¯ä¿¡æ¯å’Œç”¨æˆ·é‚®ç®±ï¼Œä»¥ä¾¿è¿›è¡Œç²¾ç¡®è¯Šæ–­ã€‚






