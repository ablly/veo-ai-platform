# 🔍 视频生成错误诊断报告

## 📋 问题概述

**用户反馈**: 在项目首页用用户账户测试生成视频时报错

**影响范围**: 核心视频生成功能无法正常使用

**紧急程度**: 🔴 高优先级 - 影响核心业务功能

## 🔍 可能的错误原因分析

### 1. API配置问题 🔧
**症状**: 速创API密钥未配置或无效
**错误信息**: `"速创API密钥未配置"` 或 `"速创API错误: 401"`
**检查方法**:
```bash
# 检查环境变量
echo $SUCHUANG_API_KEY
echo $SUCHUANG_API_URL
```

### 2. 用户积分不足 💳
**症状**: 用户积分余额少于15积分
**错误信息**: `"积分不足，需要 15 积分，当前余额 X 积分"`
**检查方法**: 查看用户积分账户表

### 3. 用户套餐过期 ⏰
**症状**: 用户套餐已过期或被标记为过期
**错误信息**: `"您的套餐已过期，请购买新套餐后继续使用"`
**检查方法**: 查看用户套餐过期时间

### 4. 外部API调用失败 🌐
**症状**: 速创API服务不可用或返回错误
**错误信息**: `"速创API调用失败"` 或具体的API错误
**检查方法**: 测试API连接性

### 5. 数据库连接问题 🗄️
**症状**: 用户数据查询失败或数据库连接异常
**错误信息**: `"用户不存在"` 或数据库连接错误
**检查方法**: 检查数据库连接和用户数据

### 6. 请求参数验证失败 ✅
**症状**: 前端发送的参数不符合后端验证规则
**错误信息**: `"缺少必需参数"` 或 `"视频描述不能为空"`
**检查方法**: 检查前端发送的请求数据

## 🛠️ 诊断步骤

### 步骤1: 检查API配置
```sql
-- 检查系统设置中的API配置
SELECT * FROM system_settings 
WHERE key IN ('suchuang_api_key', 'suchuang_api_url');
```

### 步骤2: 检查用户状态
```sql
-- 检查用户积分和套餐状态
SELECT 
  u.id, u.email, u.name,
  COALESCE(uca.available_credits, 0) as available_credits,
  uca.package_expires_at,
  uca.is_expired,
  uca.package_name
FROM users u 
LEFT JOIN user_credit_accounts uca ON u.id = uca.user_id 
WHERE u.email = '用户邮箱';
```

### 步骤3: 检查最近的错误日志
```sql
-- 查看最近的视频生成记录
SELECT * FROM video_generations 
WHERE created_at >= NOW() - INTERVAL '1 hour'
ORDER BY created_at DESC 
LIMIT 10;
```

### 步骤4: 测试API连接
- 使用管理后台的API测试功能
- 检查速创API的可用性和响应

## 🔧 修复方案

### 方案1: API配置修复
```typescript
// 确保环境变量正确设置
SUCHUANG_API_KEY=your_actual_api_key
SUCHUANG_API_URL=https://api.wuyinkeji.com

// 或在系统设置中配置
INSERT INTO system_settings (key, value, description) VALUES
('suchuang_api_key', 'your_api_key', '速创API密钥'),
('suchuang_api_url', 'https://api.wuyinkeji.com', '速创API地址');
```

### 方案2: 用户积分修复
```sql
-- 为测试用户添加积分
INSERT INTO user_credit_accounts (
  user_id, available_credits, total_credits, used_credits, frozen_credits
) VALUES (
  'user_id', 100, 100, 0, 0
) ON CONFLICT (user_id) DO UPDATE SET
  available_credits = 100,
  total_credits = 100,
  updated_at = NOW();
```

### 方案3: 套餐过期修复
```sql
-- 延长用户套餐有效期
UPDATE user_credit_accounts 
SET 
  package_expires_at = NOW() + INTERVAL '90 days',
  is_expired = false,
  package_name = '测试套餐',
  updated_at = NOW()
WHERE user_id = 'user_id';
```

### 方案4: 错误处理增强
```typescript
// 在视频生成API中添加更详细的错误日志
logger.error("视频生成详细错误", {
  user_email: session.user.email,
  error_type: error.constructor.name,
  error_message: error.message,
  error_stack: error.stack,
  request_body: body,
  timestamp: new Date().toISOString()
})
```

## 🚨 紧急修复建议

### 立即执行的修复步骤:

1. **检查API密钥配置**:
   - 确认系统设置中的速创API密钥是否正确
   - 使用管理后台测试API连接

2. **为测试用户添加积分**:
   ```sql
   -- 快速为测试用户添加积分
   UPDATE user_credit_accounts 
   SET available_credits = 100 
   WHERE user_id IN (
     SELECT id FROM users WHERE email = '测试用户邮箱'
   );
   ```

3. **检查用户套餐状态**:
   ```sql
   -- 确保测试用户套餐未过期
   UPDATE user_credit_accounts 
   SET is_expired = false,
       package_expires_at = NOW() + INTERVAL '30 days'
   WHERE user_id IN (
     SELECT id FROM users WHERE email = '测试用户邮箱'
   );
   ```

4. **启用详细日志记录**:
   - 临时增加视频生成API的日志级别
   - 记录所有请求和响应数据

## 📊 监控和预防

### 实时监控指标:
- API调用成功率
- 用户积分余额分布
- 套餐过期提醒
- 错误日志统计

### 预防措施:
1. **API健康检查**: 定期测试外部API可用性
2. **积分预警**: 用户积分低于阈值时自动提醒
3. **套餐到期提醒**: 提前7天发送过期提醒
4. **错误监控**: 实时监控错误率和异常模式

## 🎯 用户体验优化

### 错误提示优化:
```typescript
// 用户友好的错误提示
const ERROR_MESSAGES = {
  INSUFFICIENT_CREDITS: "积分不足，请前往充值页面购买积分包",
  PACKAGE_EXPIRED: "您的套餐已过期，请续费后继续使用",
  API_ERROR: "服务暂时不可用，请稍后重试或联系客服",
  VALIDATION_ERROR: "请检查输入内容是否符合要求"
}
```

### 前端错误处理:
```typescript
// 在首页添加更好的错误处理
catch (error) {
  console.error("生成失败:", error)
  
  // 根据错误类型显示不同的提示
  if (error.message.includes("积分不足")) {
    // 显示充值引导
    showCreditsPurchaseModal()
  } else if (error.message.includes("过期")) {
    // 显示续费引导
    showRenewalModal()
  } else {
    // 显示通用错误提示
    alert("生成失败，请稍后重试")
  }
}
```

## 🔍 调试工具

### 1. API测试工具
```bash
# 直接测试速创API
curl -X POST "https://api.wuyinkeji.com/api/video/veoPlus" \
  -H "Content-Type: application/json" \
  -H "Authorization: YOUR_API_KEY" \
  -d '{
    "model": "veo3",
    "prompt": "测试视频生成",
    "type": "text2video",
    "ratio": "16:9"
  }'
```

### 2. 数据库查询工具
```sql
-- 完整的用户状态检查
SELECT 
  u.id, u.email, u.name, u.created_at,
  uca.available_credits, uca.total_credits, uca.used_credits,
  uca.package_name, uca.package_expires_at, uca.is_expired,
  COUNT(vg.id) as total_videos,
  COUNT(CASE WHEN vg.status = 'COMPLETED' THEN 1 END) as completed_videos,
  COUNT(CASE WHEN vg.status = 'FAILED' THEN 1 END) as failed_videos
FROM users u
LEFT JOIN user_credit_accounts uca ON u.id = uca.user_id
LEFT JOIN video_generations vg ON u.id = vg.user_id
WHERE u.email = '测试用户邮箱'
GROUP BY u.id, uca.user_id;
```

### 3. 日志分析工具
```bash
# 查看最近的错误日志
tail -f logs/application.log | grep "视频生成失败"

# 统计错误类型
grep "视频生成失败" logs/application.log | \
  jq -r '.error_type' | sort | uniq -c
```

## 📋 检查清单

### 系统配置检查:
- [ ] 速创API密钥已配置且有效
- [ ] 速创API地址正确
- [ ] 数据库连接正常
- [ ] 环境变量设置正确

### 用户数据检查:
- [ ] 测试用户存在且状态正常
- [ ] 用户有足够的积分余额
- [ ] 用户套餐未过期
- [ ] 用户权限设置正确

### 功能测试检查:
- [ ] 前端表单验证正常
- [ ] API请求格式正确
- [ ] 错误处理机制工作
- [ ] 日志记录完整

---

**🎯 下一步行动**:
1. 立即检查API配置和用户积分状态
2. 执行紧急修复方案
3. 进行完整的功能测试
4. 优化错误提示和用户体验

**📞 如需支持**: 请提供具体的错误信息和用户邮箱，以便进行精确诊断。






