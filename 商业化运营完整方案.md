# ğŸ’° VEO AIå¹³å° - å•†ä¸šåŒ–è¿è¥å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

- [å•†ä¸šæ¨¡å¼æ¦‚è¿°](#å•†ä¸šæ¨¡å¼æ¦‚è¿°)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [å¾®ä¿¡ç™»å½•é›†æˆ](#å¾®ä¿¡ç™»å½•é›†æˆ)
- [å¾®ä¿¡æ”¯ä»˜é›†æˆ](#å¾®ä¿¡æ”¯ä»˜é›†æˆ)
- [VivaAPIé›†æˆ](#vivaapié›†æˆ)
- [å®Œæ•´ä¸šåŠ¡æµç¨‹](#å®Œæ•´ä¸šåŠ¡æµç¨‹)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [APIå®ç°](#apiå®ç°)
- [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
- [è¿è¥å»ºè®®](#è¿è¥å»ºè®®)

---

## ğŸ¯ å•†ä¸šæ¨¡å¼æ¦‚è¿°

### ä¸šåŠ¡æ¨¡å¼

æ‚¨çš„VEO AIå¹³å°é‡‡ç”¨**SaaSè®¢é˜…åˆ¶ + APIè½¬å”®**çš„å•†ä¸šæ¨¡å¼ï¼š

1. **ç”¨æˆ·æ³¨å†Œç™»å½•**ï¼ˆå¾®ä¿¡ç™»å½•ï¼‰
2. **è´­ä¹°ç§¯åˆ†å¥—é¤**ï¼ˆå¾®ä¿¡æ”¯ä»˜ï¼‰
3. **ä½¿ç”¨VEO 3æœåŠ¡**ï¼ˆé€šè¿‡VivaAPIï¼‰
4. **æŒ‰ç§¯åˆ†æ¶ˆè€—è®¡è´¹**

### ç›ˆåˆ©æ¨¡å¼

```
VivaAPIè´­ä¹°ä»·æ ¼ < æ‚¨çš„é”€å”®ä»·æ ¼ = åˆ©æ¶¦ç©ºé—´
```

**ç¤ºä¾‹**:
- æ‚¨ä»VivaAPIè´­ä¹°: Â¥1/ç§¯åˆ†
- æ‚¨å‘ç”¨æˆ·é”€å”®: Â¥1.5/ç§¯åˆ†
- åˆ©æ¶¦ç‡: 50%

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·å±‚                           â”‚
â”‚  å¾®ä¿¡å°ç¨‹åº/H5 â†’ ç½‘ç«™å‰ç«¯ â†’ è§†é¢‘ç”Ÿæˆç•Œé¢             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚å¾®ä¿¡ç™»å½•  â”‚  â”‚å¾®ä¿¡æ”¯ä»˜  â”‚  â”‚VivaAPIè°ƒç”¨  â”‚       â”‚
â”‚  â”‚  OAuth   â”‚  â”‚  JSAPI   â”‚  â”‚  VEO 3 API  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å±‚                             â”‚
â”‚  ç”¨æˆ·è¡¨ â”‚ è®¢å•è¡¨ â”‚ ç§¯åˆ†è¡¨ â”‚ APIè°ƒç”¨è®°å½•è¡¨           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

- **å‰ç«¯**: Next.js 15 + React
- **åç«¯**: Next.js API Routes
- **æ•°æ®åº“**: PostgreSQL (Supabase)
- **æ”¯ä»˜**: å¾®ä¿¡æ”¯ä»˜
- **è§†é¢‘ç”Ÿæˆ**: VivaAPI (VEO 3)
- **è®¤è¯**: NextAuth.js (å¾®ä¿¡OAuth)

---

## ğŸ” å¾®ä¿¡ç™»å½•é›†æˆ

### 1. å‰ç½®å‡†å¤‡

#### ç”³è¯·å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·

1. **è®¿é—®**: https://open.weixin.qq.com
2. **æ³¨å†Œ**: ä¼ä¸šè´¦å·ï¼ˆéœ€è¦è¥ä¸šæ‰§ç…§ï¼‰
3. **åˆ›å»ºç½‘ç«™åº”ç”¨**: 
   - åº”ç”¨åç§°: VEO AIè§†é¢‘ç”Ÿæˆå¹³å°
   - åº”ç”¨åŸŸå: your-domain.com
   - å®¡æ ¸å‘¨æœŸ: 7-15å¤©

#### è·å–é…ç½®ä¿¡æ¯

ç™»å½•åè·å–:
- `AppID`: åº”ç”¨å”¯ä¸€æ ‡è¯†
- `AppSecret`: åº”ç”¨å¯†é’¥

### 2. ä»£ç å®ç°

#### æ›´æ–°NextAuthé…ç½®

æ–‡ä»¶: `src/lib/auth.ts`

```typescript
import WeChatProvider from "next-auth/providers/wechat"

export const authOptions: NextAuthOptions = {
  providers: [
    // å¾®ä¿¡ç™»å½• - ç½‘é¡µç‰ˆ
    WeChatProvider({
      clientId: process.env.WECHAT_APP_ID!,
      clientSecret: process.env.WECHAT_APP_SECRET!,
      authorization: {
        url: "https://open.weixin.qq.com/connect/qrconnect",
        params: {
          scope: "snsapi_login",
          // å›è°ƒåœ°å€ä¼šè‡ªåŠ¨é…ç½®
        }
      },
      userinfo: "https://api.weixin.qq.com/sns/userinfo",
      profile(profile) {
        return {
          id: profile.unionid,
          name: profile.nickname,
          email: `${profile.unionid}@wechat.user`,
          image: profile.headimgurl,
        }
      },
    }),
    
    // ä¿ç•™å…¶ä»–ç™»å½•æ–¹å¼
    // ...
  ],
  
  callbacks: {
    async signIn({ user, account, profile }) {
      if (account?.provider === "wechat") {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
        const existingUser = await pool.query(
          'SELECT * FROM users WHERE wechat_unionid = $1',
          [profile?.unionid]
        )

        if (existingUser.rows.length === 0) {
          // æ–°ç”¨æˆ·ï¼Œåˆ›å»ºè´¦æˆ·å¹¶èµ é€10ç§¯åˆ†
          const client = await pool.connect()
          try {
            await client.query('BEGIN')

            const userResult = await client.query(
              `INSERT INTO users (email, name, avatar, wechat_unionid, wechat_openid)
               VALUES ($1, $2, $3, $4, $5)
               RETURNING id`,
              [
                `${profile?.unionid}@wechat.user`,
                profile?.nickname,
                profile?.headimgurl,
                profile?.unionid,
                profile?.openid
              ]
            )

            const userId = userResult.rows[0].id

            // åˆ›å»ºç§¯åˆ†è´¦æˆ·å¹¶èµ é€10ç§¯åˆ†
            await client.query(
              `INSERT INTO user_credit_accounts 
               (user_id, available_credits, total_credits)
               VALUES ($1, 10, 10)`,
              [userId]
            )

            await client.query('COMMIT')
          } catch (error) {
            await client.query('ROLLBACK')
            throw error
          } finally {
            client.release()
          }
        }
      }
      return true
    },
  },
}
```

#### ç¯å¢ƒå˜é‡é…ç½®

æ–‡ä»¶: `.env`

```env
# å¾®ä¿¡ç™»å½•é…ç½®
WECHAT_APP_ID="wx1234567890abcdef"
WECHAT_APP_SECRET="1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p"
```

### 3. å‰ç«¯ç™»å½•æŒ‰é’®

æ–‡ä»¶: `src/app/login/page.tsx`

```tsx
import { signIn } from "next-auth/react"

<Button
  onClick={() => signIn('wechat', { callbackUrl: '/' })}
  className="w-full bg-green-500 hover:bg-green-600"
>
  <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24">
    {/* å¾®ä¿¡å›¾æ ‡ */}
  </svg>
  å¾®ä¿¡ç™»å½•
</Button>
```

---

## ğŸ’³ å¾®ä¿¡æ”¯ä»˜é›†æˆ

### 1. å‰ç½®å‡†å¤‡

#### å¼€é€šå¾®ä¿¡æ”¯ä»˜å•†æˆ·å·

1. **è®¿é—®**: https://pay.weixin.qq.com
2. **æ³¨å†Œ**: å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·ï¼ˆéœ€è¦è¥ä¸šæ‰§ç…§ã€é“¶è¡Œè´¦æˆ·ï¼‰
3. **è·å–é…ç½®**:
   - å•†æˆ·å· (MchID)
   - APIå¯†é’¥ (API Key V3)
   - å•†æˆ·è¯ä¹¦

#### å®‰å…¨é…ç½®

- ä¸‹è½½å•†æˆ·è¯ä¹¦ï¼ˆapiclient_cert.pemå’Œapiclient_key.pemï¼‰
- ä¿å­˜åˆ°å®‰å…¨ä½ç½®ï¼Œä¸è¦æäº¤åˆ°Git

### 2. å®‰è£…SDK

```bash
npm install wechatpay-node-v3
```

### 3. åˆ›å»ºæ”¯ä»˜API

#### æ–‡ä»¶: `src/app/api/payment/create-order/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server"
import { getServerSession } from "next-auth/next"
import { authOptions } from "@/lib/auth"
import { Payment } from "wechatpay-node-v3"
import { pool } from "@/lib/db"
import crypto from "crypto"

// åˆå§‹åŒ–å¾®ä¿¡æ”¯ä»˜
const payment = new Payment({
  appid: process.env.WECHAT_APP_ID!,
  mchid: process.env.WECHAT_MCH_ID!,
  private_key: process.env.WECHAT_PRIVATE_KEY!, // å•†æˆ·ç§é’¥
  serial_no: process.env.WECHAT_SERIAL_NO!, // è¯ä¹¦åºåˆ—å·
  apiv3_private_key: process.env.WECHAT_APIV3_KEY!, // APIv3å¯†é’¥
  notify_url: `${process.env.NEXTAUTH_URL}/api/payment/notify`, // æ”¯ä»˜å›è°ƒåœ°å€
})

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.email) {
      return NextResponse.json({ error: "æœªç™»å½•" }, { status: 401 })
    }

    const { packageId } = await request.json()

    // æŸ¥è¯¢å¥—é¤ä¿¡æ¯
    const packageResult = await pool.query(
      'SELECT * FROM credit_packages WHERE id = $1 AND is_active = true',
      [packageId]
    )

    if (packageResult.rows.length === 0) {
      return NextResponse.json({ error: "å¥—é¤ä¸å­˜åœ¨" }, { status: 404 })
    }

    const pkg = packageResult.rows[0]

    // æŸ¥è¯¢ç”¨æˆ·ID
    const userResult = await pool.query(
      'SELECT id FROM users WHERE email = $1',
      [session.user.email]
    )
    const userId = userResult.rows[0].id

    // åˆ›å»ºè®¢å•
    const orderNo = `ORD${Date.now()}${crypto.randomBytes(4).toString('hex').toUpperCase()}`
    
    const orderResult = await pool.query(
      `INSERT INTO orders 
       (order_no, user_id, package_id, package_name, credits, amount, status, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, 'PENDING', NOW())
       RETURNING id`,
      [orderNo, userId, packageId, pkg.name, pkg.credits, pkg.price]
    )

    const orderId = orderResult.rows[0].id

    // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å•
    const result = await payment.native({
      description: pkg.name,
      out_trade_no: orderNo,
      amount: {
        total: Math.round(pkg.price * 100), // å•ä½ï¼šåˆ†
        currency: 'CNY'
      },
      attach: JSON.stringify({ orderId, userId }),
    })

    // è¿”å›æ”¯ä»˜äºŒç»´ç URL
    return NextResponse.json({
      success: true,
      orderId,
      orderNo,
      qrCode: result.code_url, // äºŒç»´ç å†…å®¹
      amount: pkg.price,
      packageName: pkg.name,
      credits: pkg.credits
    })

  } catch (error) {
    console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error)
    return NextResponse.json({ error: "åˆ›å»ºè®¢å•å¤±è´¥" }, { status: 500 })
  }
}
```

#### æ–‡ä»¶: `src/app/api/payment/notify/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server"
import { Payment } from "wechatpay-node-v3"
import { pool } from "@/lib/db"

const payment = new Payment({
  // ... åŒä¸Šé…ç½®
})

export async function POST(request: NextRequest) {
  try {
    const body = await request.text()
    const signature = request.headers.get('wechatpay-signature')
    const timestamp = request.headers.get('wechatpay-timestamp')
    const nonce = request.headers.get('wechatpay-nonce')
    const serial = request.headers.get('wechatpay-serial')

    // éªŒè¯ç­¾å
    const isValid = payment.verifySign({
      body,
      signature: signature!,
      serial: serial!,
      nonce: nonce!,
      timestamp: timestamp!,
    })

    if (!isValid) {
      return NextResponse.json({ code: 'FAIL', message: 'ç­¾åéªŒè¯å¤±è´¥' })
    }

    // è§£å¯†æ•°æ®
    const data = JSON.parse(body)
    const decrypted = payment.decipher_gcm(
      data.resource.ciphertext,
      data.resource.associated_data,
      data.resource.nonce
    )

    const paymentData = JSON.parse(decrypted)

    // å¤„ç†æ”¯ä»˜æˆåŠŸ
    if (paymentData.trade_state === 'SUCCESS') {
      const orderNo = paymentData.out_trade_no
      const attach = JSON.parse(paymentData.attach)

      const client = await pool.connect()
      try {
        await client.query('BEGIN')

        // æ›´æ–°è®¢å•çŠ¶æ€
        const orderResult = await client.query(
          `UPDATE orders 
           SET status = 'PAID', 
               transaction_id = $1,
               paid_at = NOW()
           WHERE order_no = $2
           RETURNING credits, user_id`,
          [paymentData.transaction_id, orderNo]
        )

        if (orderResult.rows.length > 0) {
          const { credits, user_id } = orderResult.rows[0]

          // å¢åŠ ç”¨æˆ·ç§¯åˆ†
          await client.query(
            `UPDATE user_credit_accounts 
             SET available_credits = available_credits + $1,
                 total_credits = total_credits + $1
             WHERE user_id = $2`,
            [credits, user_id]
          )

          // è®°å½•ç§¯åˆ†äº¤æ˜“
          await client.query(
            `INSERT INTO credit_transactions 
             (user_id, type, amount, description, created_at)
             VALUES ($1, 'PURCHASE', $2, $3, NOW())`,
            [user_id, credits, `è´­ä¹°å¥—é¤ï¼š${paymentData.description}`]
          )
        }

        await client.query('COMMIT')
      } catch (error) {
        await client.query('ROLLBACK')
        throw error
      } finally {
        client.release()
      }
    }

    return NextResponse.json({ code: 'SUCCESS', message: 'æˆåŠŸ' })

  } catch (error) {
    console.error('å¤„ç†æ”¯ä»˜å›è°ƒå¤±è´¥:', error)
    return NextResponse.json({ code: 'FAIL', message: 'å¤„ç†å¤±è´¥' })
  }
}
```

### 4. å‰ç«¯æ”¯ä»˜æµç¨‹

#### æ–‡ä»¶: `src/app/credits/page.tsx`

```typescript
const handlePurchase = async (packageId: string) => {
  try {
    // åˆ›å»ºè®¢å•
    const response = await fetch('/api/payment/create-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ packageId })
    })

    const data = await response.json()

    if (data.success) {
      // æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç å¼¹çª—
      setPaymentQrCode(data.qrCode)
      setShowPaymentModal(true)
      
      // å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€
      startPollingOrderStatus(data.orderId)
    }
  } catch (error) {
    alert('åˆ›å»ºè®¢å•å¤±è´¥')
  }
}

const startPollingOrderStatus = (orderId: string) => {
  const interval = setInterval(async () => {
    const response = await fetch(`/api/payment/check-status?orderId=${orderId}`)
    const data = await response.json()

    if (data.status === 'PAID') {
      clearInterval(interval)
      setShowPaymentModal(false)
      alert('æ”¯ä»˜æˆåŠŸï¼ç§¯åˆ†å·²åˆ°è´¦')
      // åˆ·æ–°ç§¯åˆ†
      fetchCreditsData()
    }
  }, 2000) // æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡

  // 5åˆ†é’Ÿååœæ­¢è½®è¯¢
  setTimeout(() => clearInterval(interval), 300000)
}
```

#### æ”¯ä»˜äºŒç»´ç å¼¹çª—ç»„ä»¶

```tsx
{showPaymentModal && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div className="bg-white rounded-lg p-8 max-w-md">
      <h3 className="text-2xl font-bold mb-4">å¾®ä¿¡æ‰«ç æ”¯ä»˜</h3>
      <div className="flex justify-center mb-4">
        <QRCodeSVG value={paymentQrCode} size={256} />
      </div>
      <p className="text-center text-gray-600">
        è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜
      </p>
      <Button onClick={() => setShowPaymentModal(false)} className="w-full mt-4">
        å–æ¶ˆæ”¯ä»˜
      </Button>
    </div>
  </div>
)}
```

### 5. ç¯å¢ƒå˜é‡é…ç½®

```env
# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_MCH_ID="1234567890"
WECHAT_SERIAL_NO="5F2E8A1B3C4D5E6F7A8B9C0D1E2F3A4B5C6D7E8F"
WECHAT_APIV3_KEY="your_apiv3_key_32_characters_long"
WECHAT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...\n-----END PRIVATE KEY-----"
```

---

## ğŸ”Œ VivaAPIé›†æˆ

### 1. å…³äºVivaAPI

**VivaAPI** (https://www.vivaapi.cn) æ˜¯ä¸€ä¸ªAI APIèšåˆå¹³å°ï¼Œæä¾›ï¼š
- VEO 3è§†é¢‘ç”ŸæˆAPI
- å…¶ä»–AIæ¨¡å‹API
- ç»Ÿä¸€çš„è°ƒç”¨æ¥å£
- æŒ‰ä½¿ç”¨é‡è®¡è´¹

### 2. è·å–VivaAPI Token

1. **æ³¨å†Œè´¦å·**: è®¿é—® https://www.vivaapi.cn
2. **å……å€¼**: è´­ä¹°APIè°ƒç”¨é¢åº¦
3. **è·å–Token**: åœ¨æ§åˆ¶å° https://www.vivaapi.cn/console/token è·å–API Token

### 3. VivaAPIè°ƒç”¨ç¤ºä¾‹

#### æ›´æ–°è§†é¢‘ç”ŸæˆAPI

æ–‡ä»¶: `src/app/api/generate/video/route.ts`

```typescript
// VivaAPIé…ç½®
const VIVA_API_URL = process.env.VIVA_API_URL || "https://api.vivaapi.cn/api/v1"
const VIVA_API_TOKEN = process.env.VIVA_API_TOKEN

// è°ƒç”¨VivaAPIç”Ÿæˆè§†é¢‘
async function callVivaAPI(options: {
  prompt: string
  images: string[]
  videoId: string
  aspectRatio?: string
}) {
  try {
    if (!VIVA_API_TOKEN) {
      throw new Error("VivaAPI Tokenæœªé…ç½®")
    }

    const { prompt, images, aspectRatio = "16:9" } = options

    // æ„å»ºè¯·æ±‚
    const payload = {
      model: "veo-3", // VivaAPIçš„VEO 3æ¨¡å‹æ ‡è¯†
      prompt,
      aspect_ratio: aspectRatio,
      image_urls: images.length > 0 ? images : undefined
    }

    logger.info("è°ƒç”¨VivaAPI", { prompt, aspectRatio })

    const response = await fetch(`${VIVA_API_URL}/video/generate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${VIVA_API_TOKEN}`
      },
      body: JSON.stringify(payload),
      signal: AbortSignal.timeout(30000)
    })

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      throw new Error(errorData.message || `VivaAPIé”™è¯¯: ${response.status}`)
    }

    const result = await response.json()
    
    // VivaAPIå“åº”æ ¼å¼å¯èƒ½ç±»ä¼¼:
    // { success: true, task_id: "xxx", status: "processing" }
    
    if (!result.success || !result.task_id) {
      throw new Error("VivaAPIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯")
    }

    logger.info("VivaAPIè°ƒç”¨æˆåŠŸ", { taskId: result.task_id })
    
    return {
      success: true,
      taskId: result.task_id
    }

  } catch (error) {
    logger.error("VivaAPIè°ƒç”¨å¤±è´¥", { 
      error: error instanceof Error ? error.message : String(error) 
    })
    return {
      success: false,
      error: error instanceof Error ? error.message : "VivaAPIè°ƒç”¨å¤±è´¥"
    }
  }
}

// æ£€æŸ¥VivaAPIçŠ¶æ€
async function checkVivaAPIStatus(taskId: string) {
  try {
    const response = await fetch(
      `${VIVA_API_URL}/video/status/${taskId}`,
      {
        headers: {
          'Authorization': `Bearer ${VIVA_API_TOKEN}`
        }
      }
    )

    const result = await response.json()
    
    // æ ¹æ®VivaAPIçš„å®é™…å“åº”æ ¼å¼è°ƒæ•´
    if (result.status === 'completed') {
      return {
        success: true,
        status: 'completed',
        videoUrl: result.video_url,
        error: null
      }
    } else if (result.status === 'failed') {
      return {
        success: true,
        status: 'failed',
        videoUrl: null,
        error: result.error || 'ç”Ÿæˆå¤±è´¥'
      }
    } else {
      return {
        success: true,
        status: 'processing',
        videoUrl: null,
        error: null
      }
    }

  } catch (error) {
    return {
      success: false,
      error: "çŠ¶æ€æŸ¥è¯¢å¤±è´¥"
    }
  }
}
```

### 4. ç¯å¢ƒå˜é‡é…ç½®

```env
# VivaAPIé…ç½®
VIVA_API_URL="https://api.vivaapi.cn/api/v1"
VIVA_API_TOKEN="your_viva_api_token_here"
```

### 5. æˆæœ¬æ§åˆ¶ç­–ç•¥

#### æ–¹æ¡ˆAï¼šç›´æ¥é€ä¼ ï¼ˆç®€å•ï¼‰

```
ç”¨æˆ·æ¶ˆè€—1ç§¯åˆ† â†’ è°ƒç”¨VivaAPIæ¶ˆè€—å¯¹åº”é¢åº¦
```

**ä¼˜ç‚¹**: å®ç°ç®€å•
**ç¼ºç‚¹**: éœ€è¦å®æ—¶å……å€¼VivaAPI

#### æ–¹æ¡ˆBï¼šé¢„è´­æ‰¹é‡ï¼ˆæ¨èï¼‰

```
1. é¢„å…ˆåœ¨VivaAPIå……å€¼å¤§é¢ï¼ˆå¦‚Â¥10000ï¼‰
2. è®¾ç½®ç”¨æˆ·ç§¯åˆ†ä»·æ ¼ï¼ˆÂ¥1.5/ç§¯åˆ†ï¼‰
3. èµšå–å·®ä»·ï¼ˆ50%åˆ©æ¶¦ï¼‰
4. å®šæœŸç›‘æ§VivaAPIä½™é¢
```

**å®ç°**:

```typescript
// å®šæœŸæ£€æŸ¥VivaAPIä½™é¢
async function checkVivaAPIBalance() {
  const response = await fetch(`${VIVA_API_URL}/account/balance`, {
    headers: { 'Authorization': `Bearer ${VIVA_API_TOKEN}` }
  })
  
  const data = await response.json()
  
  if (data.balance < 1000) { // ä½™é¢ä½äºÂ¥1000
    // å‘é€å‘Šè­¦é‚®ä»¶/çŸ­ä¿¡
    sendAlert('VivaAPIä½™é¢ä¸è¶³ï¼Œè¯·åŠæ—¶å……å€¼')
  }
}

// æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
setInterval(checkVivaAPIBalance, 3600000)
```

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹

### ç”¨æˆ·è´­ä¹°åˆ°ä½¿ç”¨çš„å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant B as åç«¯
    participant WX as å¾®ä¿¡æ”¯ä»˜
    participant V as VivaAPI
    participant DB as æ•°æ®åº“

    %% ç™»å½•æµç¨‹
    U->>F: ç‚¹å‡»å¾®ä¿¡ç™»å½•
    F->>WX: OAuthæˆæƒ
    WX-->>U: æ‰«ç æˆæƒ
    WX-->>B: è¿”å›ç”¨æˆ·ä¿¡æ¯
    B->>DB: åˆ›å»º/æŸ¥è¯¢ç”¨æˆ·
    DB-->>B: ç”¨æˆ·ID
    B->>DB: èµ é€10ç§¯åˆ†ï¼ˆæ–°ç”¨æˆ·ï¼‰
    B-->>F: ç™»å½•æˆåŠŸ

    %% è´­ä¹°æµç¨‹
    U->>F: é€‰æ‹©å¥—é¤è´­ä¹°
    F->>B: åˆ›å»ºè®¢å•
    B->>DB: ä¿å­˜è®¢å•(PENDING)
    B->>WX: è°ƒç”¨ç»Ÿä¸€ä¸‹å•API
    WX-->>B: è¿”å›æ”¯ä»˜äºŒç»´ç 
    B-->>F: è¿”å›äºŒç»´ç URL
    F-->>U: æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç 
    U->>WX: æ‰«ç æ”¯ä»˜
    WX->>B: æ”¯ä»˜æˆåŠŸå›è°ƒ
    B->>DB: æ›´æ–°è®¢å•(PAID)
    B->>DB: å¢åŠ ç”¨æˆ·ç§¯åˆ†
    B-->>WX: è¿”å›æˆåŠŸ
    F->>B: è½®è¯¢è®¢å•çŠ¶æ€
    B-->>F: æ”¯ä»˜æˆåŠŸ
    F-->>U: æ˜¾ç¤ºæˆåŠŸï¼Œç§¯åˆ†å·²åˆ°è´¦

    %% ä½¿ç”¨æµç¨‹
    U->>F: è¾“å…¥è§†é¢‘æè¿°ï¼Œç‚¹å‡»ç”Ÿæˆ
    F->>B: è°ƒç”¨ç”ŸæˆAPI
    B->>DB: æ£€æŸ¥ç”¨æˆ·ç§¯åˆ†
    DB-->>B: ç§¯åˆ†å……è¶³
    B->>DB: æ‰£é™¤5ç§¯åˆ†
    B->>V: è°ƒç”¨VivaAPIç”Ÿæˆè§†é¢‘
    V-->>B: è¿”å›taskId
    B->>DB: ä¿å­˜ä»»åŠ¡è®°å½•
    B-->>F: è¿”å›taskId
    F->>B: è½®è¯¢ä»»åŠ¡çŠ¶æ€
    B->>V: æŸ¥è¯¢VivaAPIçŠ¶æ€
    V-->>B: è¿”å›çŠ¶æ€
    B-->>F: è¿”å›çŠ¶æ€
    
    %% ç”Ÿæˆå®Œæˆ
    V->>V: è§†é¢‘ç”Ÿæˆå®Œæˆ
    F->>B: æŸ¥è¯¢çŠ¶æ€
    B->>V: è·å–æœ€æ–°çŠ¶æ€
    V-->>B: completed + è§†é¢‘URL
    B->>DB: æ›´æ–°ä»»åŠ¡çŠ¶æ€
    B-->>F: è¿”å›è§†é¢‘URL
    F-->>U: æ˜¾ç¤ºè§†é¢‘
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ–°å¢è¡¨ç»“æ„

#### è®¢å•è¡¨ (orders)

```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_no VARCHAR(50) UNIQUE NOT NULL,
  user_id UUID REFERENCES users(id),
  package_id UUID REFERENCES credit_packages(id),
  package_name VARCHAR(100),
  credits INTEGER NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  status VARCHAR(20) NOT NULL, -- PENDING, PAID, CANCELLED, REFUNDED
  transaction_id VARCHAR(100), -- å¾®ä¿¡æ”¯ä»˜äº¤æ˜“å·
  payment_method VARCHAR(20) DEFAULT 'WECHAT_PAY',
  created_at TIMESTAMP DEFAULT NOW(),
  paid_at TIMESTAMP,
  cancelled_at TIMESTAMP
);

CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_order_no ON orders(order_no);
```

#### ç”¨æˆ·è¡¨æ–°å¢å­—æ®µ

```sql
ALTER TABLE users ADD COLUMN wechat_unionid VARCHAR(100) UNIQUE;
ALTER TABLE users ADD COLUMN wechat_openid VARCHAR(100);
ALTER TABLE users ADD COLUMN wechat_nickname VARCHAR(100);

CREATE INDEX idx_users_wechat_unionid ON users(wechat_unionid);
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ”¯ä»˜å®‰å…¨

- âœ… ä½¿ç”¨HTTPS
- âœ… éªŒè¯å¾®ä¿¡ç­¾å
- âœ… è®¢å•é˜²é‡æ”¾
- âœ… é‡‘é¢æ ¡éªŒ
- âœ… å¼‚æ­¥å›è°ƒéªŒè¯

### 2. APIå®‰å…¨

- âœ… VivaAPI TokenåŠ å¯†å­˜å‚¨
- âœ… è¯·æ±‚é™æµ
- âœ… é”™è¯¯é‡è¯•æœºåˆ¶
- âœ… æ—¥å¿—è®°å½•æ‰€æœ‰è°ƒç”¨

### 3. æ•°æ®å®‰å…¨

- âœ… ç”¨æˆ·éšç§æ•°æ®åŠ å¯†
- âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“
- âœ… æ•æ„Ÿä¿¡æ¯è„±æ•
- âœ… SQLæ³¨å…¥é˜²æŠ¤

---

## ğŸ’¡ è¿è¥å»ºè®®

### 1. å®šä»·ç­–ç•¥

#### å¥—é¤è®¾è®¡

| å¥—é¤åç§° | ç§¯åˆ† | å”®ä»· | VivaAPIæˆæœ¬ | åˆ©æ¶¦ | åˆ©æ¶¦ç‡ |
|---------|------|------|-------------|------|--------|
| ä½“éªŒç‰ˆ | 10 | Â¥9.9 | Â¥5 | Â¥4.9 | 98% |
| åŸºç¡€ç‰ˆ | 50 | Â¥39 | Â¥25 | Â¥14 | 56% |
| ä¸“ä¸šç‰ˆ | 200 | Â¥129 | Â¥100 | Â¥29 | 29% |
| ä¼ä¸šç‰ˆ | 1000 | Â¥499 | Â¥500 | -Â¥1 | -0.2% |

**ç­–ç•¥**:
- ä½“éªŒç‰ˆï¼šé«˜åˆ©æ¶¦å¸å¼•æ–°ç”¨æˆ·
- åŸºç¡€ç‰ˆ/ä¸“ä¸šç‰ˆï¼šä¸»åŠ›å¥—é¤
- ä¼ä¸šç‰ˆï¼šä¿æœ¬å¼•æµå¤§å®¢æˆ·

### 2. æ¨å¹¿ç­–ç•¥

1. **æ–°ç”¨æˆ·ç¦åˆ©**
   - æ³¨å†Œé€10ç§¯åˆ†
   - é¦–æ¬¡è´­ä¹°8æŠ˜

2. **åˆ†é”€è¿”åˆ©**
   - é‚€è¯·å¥½å‹å¥–åŠ±
   - å¤šçº§åˆ†é”€ç³»ç»Ÿ

3. **ä¼šå‘˜åˆ¶åº¦**
   - æœˆå¡/å¹´å¡
   - VIPäº«æŠ˜æ‰£

### 3. æˆæœ¬æ§åˆ¶

#### ç›‘æ§VivaAPIæ¶ˆè€—

```typescript
// æ¯æ—¥æˆæœ¬æŠ¥å‘Š
async function generateDailyCostReport() {
  const today = new Date().toISOString().split('T')[0]
  
  // ç»Ÿè®¡ä»Šæ—¥ç”Ÿæˆè§†é¢‘æ•°é‡
  const result = await pool.query(
    `SELECT COUNT(*) as count, SUM(credits_consumed) as total_credits
     FROM video_generations
     WHERE DATE(created_at) = $1 AND status = 'COMPLETED'`,
    [today]
  )
  
  const { count, total_credits } = result.rows[0]
  
  // VivaAPIæˆæœ¬ï¼ˆå‡è®¾1ç§¯åˆ† = Â¥0.5ï¼‰
  const vivaAPICost = total_credits * 0.5
  
  // ç”¨æˆ·å……å€¼æ”¶å…¥
  const incomeResult = await pool.query(
    `SELECT SUM(amount) as total_income
     FROM orders
     WHERE DATE(paid_at) = $1 AND status = 'PAID'`,
    [today]
  )
  
  const totalIncome = incomeResult.rows[0].total_income || 0
  const profit = totalIncome - vivaAPICost
  
  console.log(`
    ğŸ“Š ${today} è¿è¥æ•°æ®:
    è§†é¢‘ç”Ÿæˆ: ${count}ä¸ª
    ç§¯åˆ†æ¶ˆè€—: ${total_credits}åˆ†
    VivaAPIæˆæœ¬: Â¥${vivaAPICost}
    ç”¨æˆ·å……å€¼: Â¥${totalIncome}
    å‡€åˆ©æ¶¦: Â¥${profit}
    åˆ©æ¶¦ç‡: ${((profit/totalIncome)*100).toFixed(2)}%
  `)
  
  return { count, total_credits, vivaAPICost, totalIncome, profit }
}
```

### 4. ç”¨æˆ·ç•™å­˜

1. **ç§¯åˆ†è¿‡æœŸæé†’**
2. **ä¼˜æƒ æ´»åŠ¨æ¨é€**
3. **æ–°åŠŸèƒ½ä½“éªŒé‚€è¯·**
4. **å®¢æœå¿«é€Ÿå“åº”**

---

## ğŸ“ å®æ–½æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1ï¼šåŸºç¡€é…ç½®

- [ ] ç”³è¯·å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·
- [ ] è·å–å¾®ä¿¡AppIDå’ŒAppSecret
- [ ] ç”³è¯·å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·
- [ ] è·å–å•†æˆ·å·å’Œè¯ä¹¦
- [ ] æ³¨å†ŒVivaAPIè´¦å·
- [ ] å……å€¼VivaAPIï¼ˆå»ºè®®Â¥1000èµ·ï¼‰
- [ ] è·å–VivaAPI Token

### é˜¶æ®µ2ï¼šä»£ç å¼€å‘

- [ ] é›†æˆå¾®ä¿¡ç™»å½•
- [ ] å®ç°å¾®ä¿¡æ”¯ä»˜ä¸‹å•
- [ ] å®ç°æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] é›†æˆVivaAPIè°ƒç”¨
- [ ] å®ç°è®¢å•ç®¡ç†
- [ ] å®ç°ç§¯åˆ†å……å€¼
- [ ] æ·»åŠ æ”¯ä»˜äºŒç»´ç å±•ç¤º

### é˜¶æ®µ3ï¼šæµ‹è¯•éªŒè¯

- [ ] æµ‹è¯•å¾®ä¿¡ç™»å½•æµç¨‹
- [ ] æµ‹è¯•æ”¯ä»˜æµç¨‹ï¼ˆå°é¢ï¼‰
- [ ] æµ‹è¯•ç§¯åˆ†åˆ°è´¦
- [ ] æµ‹è¯•VivaAPIè°ƒç”¨
- [ ] æµ‹è¯•è§†é¢‘ç”Ÿæˆ
- [ ] æµ‹è¯•å¼‚å¸¸æƒ…å†µå¤„ç†

### é˜¶æ®µ4ï¼šä¸Šçº¿è¿è¥

- [ ] è´­ä¹°åŸŸåå¹¶å¤‡æ¡ˆ
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] é…ç½®HTTPSè¯ä¹¦
- [ ] è®¾ç½®ç›‘æ§å‘Šè­¦
- [ ] å‡†å¤‡å®¢æœç³»ç»Ÿ
- [ ] å¼€å§‹æ¨å¹¿è¿è¥

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **å®Œæ•´é—­ç¯**: ç™»å½• â†’ æ”¯ä»˜ â†’ ä½¿ç”¨ â†’ æ¶ˆè´¹
2. **æŠ€æœ¯æˆç†Ÿ**: Next.js + å¾®ä¿¡ + VivaAPI
3. **ç›ˆåˆ©æ¨¡å¼æ¸…æ™°**: APIè½¬å”®èµšå–å·®ä»·
4. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½

### é¢„æœŸæ”¶ç›Š

**æœˆåº¦é¢„ä¼°ï¼ˆä¿å®ˆï¼‰**:
- ç”¨æˆ·æ•°: 1000äºº
- å¹³å‡æ¶ˆè´¹: Â¥50/äºº
- æ€»æ”¶å…¥: Â¥50,000
- VivaAPIæˆæœ¬: Â¥30,000
- **å‡€åˆ©æ¶¦: Â¥20,000**

**æœˆåº¦é¢„ä¼°ï¼ˆä¹è§‚ï¼‰**:
- ç”¨æˆ·æ•°: 5000äºº
- å¹³å‡æ¶ˆè´¹: Â¥100/äºº
- æ€»æ”¶å…¥: Â¥500,000
- VivaAPIæˆæœ¬: Â¥300,000
- **å‡€åˆ©æ¶¦: Â¥200,000**

---

**ç¥æ‚¨çš„VEO AIå¹³å°å•†ä¸šåŒ–è¿è¥æˆåŠŸï¼** ğŸš€ğŸ’°

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿éšæ—¶å’¨è¯¢ï¼


