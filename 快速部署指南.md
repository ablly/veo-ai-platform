# 🚀 VEO AI平台 - 快速部署指南

## 📋 部署前检查清单

在部署之前，请确认以下内容：

- ✅ 所有功能已在本地测试通过
- ✅ `.env` 文件配置正确
- ✅ 数据库连接正常
- ✅ Supabase Storage配置完成
- ✅ 代码已推送到Git仓库

---

## 🌟 方案一：Vercel部署（推荐）

### 为什么选择Vercel？
- ✅ Next.js官方推荐平台
- ✅ 自动CI/CD
- ✅ 全球CDN加速
- ✅ 免费HTTPS证书
- ✅ 零配置部署

### 步骤1：准备Git仓库

```bash
# 如果还没有Git仓库，先初始化
cd veo-ai-platform
git init

# 添加.gitignore（确保不提交敏感信息）
# 已有.gitignore文件，检查是否包含：
# .env
# .env.local
# node_modules/
# .next/

# 提交代码
git add .
git commit -m "Initial commit - VEO AI Platform"

# 推送到GitHub/GitLab/Bitbucket
# 先在GitHub创建仓库，然后：
git remote add origin https://github.com/YOUR_USERNAME/veo-ai-platform.git
git branch -M main
git push -u origin main
```

### 步骤2：导入到Vercel

1. **访问Vercel**
   - 打开 https://vercel.com
   - 使用GitHub账号登录

2. **导入项目**
   - 点击 "New Project"
   - 选择您的仓库 `veo-ai-platform`
   - 点击 "Import"

3. **配置项目**
   - **Framework Preset**: Next.js（自动检测）
   - **Root Directory**: ./（保持默认）
   - **Build Command**: `npm run build`
   - **Output Directory**: `.next`（自动）

### 步骤3：配置环境变量

在Vercel项目设置中添加环境变量：

```env
# 数据库
DATABASE_URL=postgresql://postgres:PASSWORD@HOST:5432/postgres

# Supabase
SUPABASE_URL=https://YOUR_PROJECT.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_KEY=your_service_key

# NextAuth（重要！）
NEXTAUTH_URL=https://your-domain.vercel.app
NEXTAUTH_SECRET=your_production_secret_key

# 微信登录（如果使用）
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret

# 邮件服务（如果使用）
RESEND_API_KEY=your_resend_api_key
FROM_EMAIL=noreply@yourdomain.com
```

⚠️ **重要提示**：
- `NEXTAUTH_SECRET` 必须是一个强密钥，可以使用以下命令生成：
  ```bash
  openssl rand -base64 32
  ```
- `NEXTAUTH_URL` 必须是您的实际域名（部署后Vercel会提供）

### 步骤4：部署

1. 点击 "Deploy"
2. 等待构建完成（通常2-3分钟）
3. 部署成功后会得到一个域名，例如：`veo-ai-platform.vercel.app`

### 步骤5：配置自定义域名（可选）

1. 在Vercel项目设置中点击 "Domains"
2. 添加您的自定义域名
3. 按照提示配置DNS记录
4. 等待DNS生效（通常几分钟到24小时）

### 步骤6：更新NextAuth URL

部署成功后，记得更新环境变量：
```env
NEXTAUTH_URL=https://your-custom-domain.com
```
或者
```env
NEXTAUTH_URL=https://veo-ai-platform.vercel.app
```

---

## 🔷 方案二：Netlify部署

### 步骤1：准备构建配置

创建 `netlify.toml` 文件：

```toml
[build]
  command = "npm run build"
  publish = ".next"

[[plugins]]
  package = "@netlify/plugin-nextjs"
```

### 步骤2：部署到Netlify

1. 访问 https://netlify.com
2. 登录并点击 "New site from Git"
3. 连接您的Git仓库
4. 配置构建设置（自动检测）
5. 添加环境变量（同Vercel）
6. 点击 "Deploy site"

---

## 🖥️ 方案三：自托管VPS部署

### 适用场景
- 需要完全控制服务器
- 有自己的VPS
- 需要自定义Nginx/Apache配置

### 步骤1：服务器准备

```bash
# 连接到服务器
ssh user@your-server-ip

# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js（使用nvm）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20

# 安装PM2（进程管理器）
npm install -g pm2

# 安装Nginx
sudo apt install nginx -y
```

### 步骤2：部署应用

```bash
# 克隆仓库
cd /var/www
sudo git clone https://github.com/YOUR_USERNAME/veo-ai-platform.git
cd veo-ai-platform

# 安装依赖
npm install

# 创建.env文件
sudo nano .env
# 粘贴环境变量配置

# 构建生产版本
npm run build

# 使用PM2启动
pm2 start npm --name "veo-ai" -- start
pm2 save
pm2 startup
```

### 步骤3：配置Nginx

```bash
# 创建Nginx配置
sudo nano /etc/nginx/sites-available/veo-ai
```

添加以下内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/veo-ai /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 配置防火墙
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 步骤4：配置SSL（使用Let's Encrypt）

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

---

## 🔧 部署后配置

### 1. 数据库初始化

确保数据库表已创建。如果使用新数据库，需要：

```bash
# 运行数据库迁移脚本
npm run db:migrate

# 或手动执行SQL
# 使用prisma/schema.prisma中定义的表结构
```

### 2. 上传示例视频

运行脚本填充示例视频数据：

```bash
node setup-real-veo-videos.js
```

### 3. 测试部署

访问您的域名，测试以下功能：
- ✅ 用户注册/登录
- ✅ 头像上传
- ✅ 视频生成页面
- ✅ 视频画廊
- ✅ 积分系统

---

## 🐛 常见问题排查

### 问题1：构建失败

**错误**: `Module not found` 或 `Cannot find module`

**解决方案**:
```bash
# 清除缓存并重新安装
rm -rf node_modules package-lock.json
npm install
npm run build
```

### 问题2：数据库连接失败

**错误**: `Error: connect ECONNREFUSED`

**解决方案**:
- 检查 `DATABASE_URL` 是否正确
- 确认数据库允许远程连接
- 检查防火墙设置
- Supabase需要添加部署平台的IP到白名单

### 问题3：NextAuth错误

**错误**: `[next-auth][error][JWT_SESSION_ERROR]`

**解决方案**:
- 确保 `NEXTAUTH_SECRET` 已设置
- 确保 `NEXTAUTH_URL` 与实际域名一致
- 重新生成 `NEXTAUTH_SECRET`:
  ```bash
  openssl rand -base64 32
  ```

### 问题4：图片/视频上传失败

**错误**: `Storage error` 或 `403 Forbidden`

**解决方案**:
- 检查 `SUPABASE_SERVICE_KEY` 是否正确
- 确认Supabase Storage bucket已创建
- 检查bucket的访问权限设置为public

### 问题5：环境变量未生效

**Vercel/Netlify**:
- 在平台设置中添加环境变量
- 重新部署触发更新

**自托管VPS**:
- 检查.env文件位置和权限
- 重启PM2进程：`pm2 restart veo-ai`

---

## 📊 性能优化建议

### 1. 启用Gzip压缩

**Vercel**: 自动启用

**Nginx**:
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

### 2. 配置CDN

- 使用Vercel Edge Network（自动）
- 或配置Cloudflare CDN

### 3. 数据库优化

- 添加适当的索引
- 使用连接池
- 考虑添加Redis缓存

---

## 🔒 安全检查清单

部署后必须检查：

- ✅ HTTPS已启用
- ✅ 环境变量未泄露到前端
- ✅ `.env` 文件未提交到Git
- ✅ API路由有适当的权限验证
- ✅ 文件上传有大小和类型限制
- ✅ 数据库连接使用SSL
- ✅ 敏感API使用速率限制

---

## 📈 监控与维护

### 推荐工具

1. **Vercel Analytics** - 网站分析
2. **Sentry** - 错误跟踪
3. **LogRocket** - 用户会话记录
4. **Uptime Robot** - 网站监控

### 日常维护

```bash
# 查看PM2日志（自托管）
pm2 logs veo-ai

# 查看错误日志
pm2 logs veo-ai --err

# 重启应用
pm2 restart veo-ai

# 更新代码
git pull
npm install
npm run build
pm2 restart veo-ai
```

---

## 🎉 部署完成！

恭喜您成功部署VEO AI平台！

### 下一步：
1. 分享您的网站链接
2. 收集用户反馈
3. 持续迭代改进
4. 考虑添加更多功能

如有任何问题，请参考项目文档或联系技术支持！

祝您的项目取得巨大成功！🚀


