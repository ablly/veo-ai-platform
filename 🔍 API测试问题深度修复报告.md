# ğŸ” APIæµ‹è¯•é—®é¢˜æ·±åº¦ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜åˆ†æ

**å½“å‰é”™è¯¯**: `APIè¿æ¥æµ‹è¯•å¤±è´¥: APIè¿æ¥å¼‚å¸¸. Unexpected token '<', '<!DOCTYPE'... is not valid JSON`

**é—®é¢˜æ ¹å› **: å¤–éƒ¨APIè¿”å›HTMLå“åº”è€Œä¸æ˜¯é¢„æœŸçš„JSONï¼Œé€šå¸¸è¡¨ç¤ºï¼š
1. ğŸ” **è®¤è¯å¤±è´¥** - APIå¯†é’¥æ— æ•ˆæˆ–è¿‡æœŸ
2. ğŸŒ **ç«¯ç‚¹é”™è¯¯** - APIåœ°å€æˆ–è·¯å¾„ä¸æ­£ç¡®
3. ğŸš« **æœåŠ¡ä¸å¯ç”¨** - APIæœåŠ¡å™¨è¿”å›é”™è¯¯é¡µé¢
4. ğŸ”’ **æƒé™é—®é¢˜** - æ²¡æœ‰è®¿é—®æŒ‡å®šç«¯ç‚¹çš„æƒé™

## ğŸ”§ æ·±åº¦ä¿®å¤æ–¹æ¡ˆ

### 1. å¢å¼ºå“åº”å¤„ç† âœ…

#### JSONè§£æä¿æŠ¤
```typescript
// ä¿®å¤å‰ - ç›´æ¥è§£æå¯èƒ½å¤±è´¥
const data = await testResponse.json()

// ä¿®å¤å - å®‰å…¨çš„è§£æå¤„ç†
let data = null
try {
  data = await testResponse.json()
} catch (parseError) {
  const textContent = await testResponse.text()
  logger.warn("APIå“åº”ä¸æ˜¯JSONæ ¼å¼", {
    contentType: testResponse.headers.get('content-type'),
    textPreview: textContent.substring(0, 200)
  })
  data = { message: "APIå“åº”æ ¼å¼å¼‚å¸¸", content: textContent.substring(0, 200) }
}
```

#### HTMLé”™è¯¯é¡µé¢è¯†åˆ«
```typescript
// æ™ºèƒ½è¯†åˆ«HTMLé”™è¯¯å“åº”
if (errorText.includes('<!DOCTYPE') || errorText.includes('<html>')) {
  errorDetails += ' (æœåŠ¡å™¨è¿”å›HTMLé”™è¯¯é¡µé¢ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥æˆ–ç«¯ç‚¹ä¸å­˜åœ¨)'
} else {
  errorDetails += ` - ${errorText.substring(0, 200)}`
}
```

### 2. è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯ âœ…

#### æˆåŠŸå“åº”å¢å¼º
```typescript
return NextResponse.json({
  success: true,
  message: "APIè¿æ¥æµ‹è¯•æˆåŠŸ",
  data: {
    status: testResponse.status,
    contentType: testResponse.headers.get('content-type'),  // æ–°å¢
    response: data
  }
})
```

#### é”™è¯¯å“åº”å¢å¼º
```typescript
logger.warn("APIè¿æ¥æµ‹è¯•å¤±è´¥", {
  api_url,
  status: testResponse.status,
  statusText: testResponse.statusText,
  contentType: testResponse.headers.get('content-type')  // æ–°å¢
})
```

### 3. å‰ç«¯ç”¨æˆ·æŒ‡å¯¼ âœ…

#### æˆåŠŸä¿¡æ¯è¯¦ç»†åŒ–
```typescript
alert('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼\n\n' + 
      `çŠ¶æ€ç : ${data.status || '200'}\n` +
      `å†…å®¹ç±»å‹: ${data.contentType || 'application/json'}\n` +
      `å“åº”æ—¶é—´: æ­£å¸¸\n` +
      `APIç«¯ç‚¹: ${settings.suchuang_api_url}/user/api-list?type=4`)
```

#### é”™è¯¯æ’æŸ¥æŒ‡å¯¼
```typescript
alert(`âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥:\n\n${result.message}\n\n` +
      `è¯·æ£€æŸ¥:\n` +
      `1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n` +
      `2. APIåœ°å€æ˜¯å¦å¯è®¿é—®\n` +
      `3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n` +
      `4. APIæœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ`)
```

## ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­

### é—®é¢˜1: è®¤è¯å¤±è´¥
**ç—‡çŠ¶**: è¿”å›HTMLç™»å½•é¡µé¢
**åŸå› **: APIå¯†é’¥æ— æ•ˆã€è¿‡æœŸæˆ–æ ¼å¼é”™è¯¯
**è§£å†³**: 
- æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤å¯†é’¥æ˜¯å¦æœ‰æ•ˆæœŸå†…
- éªŒè¯å¯†é’¥æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚

### é—®é¢˜2: ç«¯ç‚¹ä¸å­˜åœ¨
**ç—‡çŠ¶**: 404é”™è¯¯æˆ–é»˜è®¤HTMLé¡µé¢
**åŸå› **: APIåœ°å€æˆ–è·¯å¾„é”™è¯¯
**è§£å†³**:
- ç¡®è®¤APIåŸºç¡€åœ°å€æ­£ç¡®
- éªŒè¯ç«¯ç‚¹è·¯å¾„ `/user/api-list?type=4`
- æ£€æŸ¥APIç‰ˆæœ¬æ˜¯å¦åŒ¹é…

### é—®é¢˜3: æœåŠ¡å™¨é”™è¯¯
**ç—‡çŠ¶**: 5xxçŠ¶æ€ç å’ŒHTMLé”™è¯¯é¡µé¢
**åŸå› **: APIæœåŠ¡å™¨å†…éƒ¨é”™è¯¯
**è§£å†³**:
- æ£€æŸ¥APIæœåŠ¡çŠ¶æ€
- è”ç³»APIæä¾›å•†
- ç¨åé‡è¯•

### é—®é¢˜4: ç½‘ç»œé—®é¢˜
**ç—‡çŠ¶**: è¿æ¥è¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯
**åŸå› **: ç½‘ç»œè¿æ¥é—®é¢˜æˆ–é˜²ç«å¢™é˜»æ­¢
**è§£å†³**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤é˜²ç«å¢™è®¾ç½®
- éªŒè¯DNSè§£æ

## ğŸ› ï¸ è°ƒè¯•å·¥å…·

### 1. æ—¥å¿—å¢å¼º
```typescript
logger.info("APIè¿æ¥æµ‹è¯•æˆåŠŸ", {
  api_url,
  response_status: testResponse.status,
  contentType: testResponse.headers.get('content-type'),
  responseSize: JSON.stringify(data).length
})
```

### 2. é”™è¯¯åˆ†ç±»
```typescript
if (fetchError.name === 'AbortError') {
  errorMessage = "è¯·æ±‚è¶…æ—¶ (10ç§’)"
} else if (fetchError.message?.includes('fetch')) {
  errorMessage = "ç½‘ç»œè¿æ¥å¤±è´¥"
} else if (fetchError.message?.includes('DNS')) {
  errorMessage = "åŸŸåè§£æå¤±è´¥"
} else {
  errorMessage = fetchError.message || "æœªçŸ¥ç½‘ç»œé”™è¯¯"
}
```

### 3. å“åº”å¤´æ£€æŸ¥
```typescript
const headers = {
  'content-type': testResponse.headers.get('content-type'),
  'server': testResponse.headers.get('server'),
  'date': testResponse.headers.get('date')
}
```

## ğŸ“Š æµ‹è¯•åœºæ™¯è¦†ç›–

### æˆåŠŸåœºæ™¯
- âœ… **æ­£å¸¸JSONå“åº”**: æ˜¾ç¤ºAPIæ•°æ®å’ŒçŠ¶æ€
- âœ… **éJSONæˆåŠŸå“åº”**: è¯†åˆ«å¹¶å¤„ç†æ–‡æœ¬å“åº”
- âœ… **éƒ¨åˆ†JSONå“åº”**: å¤„ç†æ ¼å¼å¼‚å¸¸ä½†æˆåŠŸçš„å“åº”

### é”™è¯¯åœºæ™¯
- âœ… **401è®¤è¯å¤±è´¥**: è¯†åˆ«HTMLç™»å½•é¡µé¢
- âœ… **404ç«¯ç‚¹ä¸å­˜åœ¨**: è¯†åˆ«HTMLé”™è¯¯é¡µé¢
- âœ… **500æœåŠ¡å™¨é”™è¯¯**: å¤„ç†æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- âœ… **ç½‘ç»œè¶…æ—¶**: 10ç§’è¶…æ—¶æ§åˆ¶
- âœ… **DNSè§£æå¤±è´¥**: ç½‘ç»œè¿æ¥é—®é¢˜
- âœ… **SSLè¯ä¹¦é”™è¯¯**: HTTPSè¿æ¥é—®é¢˜

### è¾¹ç•Œåœºæ™¯
- âœ… **ç©ºå“åº”**: å¤„ç†ç©ºå†…å®¹å“åº”
- âœ… **å¤§å“åº”**: æˆªå–å‰200å­—ç¬¦é¢„è§ˆ
- âœ… **ç‰¹æ®Šå­—ç¬¦**: å¤„ç†éUTF-8ç¼–ç 
- âœ… **é‡å®šå‘**: å¤„ç†3xxçŠ¶æ€ç 

## ğŸ¯ ç”¨æˆ·æŒ‡å¯¼

### APIé…ç½®æ£€æŸ¥æ¸…å•
```
â–¡ APIå¯†é’¥æ ¼å¼æ­£ç¡® (é€šå¸¸æ˜¯é•¿å­—ç¬¦ä¸²)
â–¡ APIåœ°å€å®Œæ•´ (åŒ…å«åè®® https://)
â–¡ APIåœ°å€å¯è®¿é—® (æµè§ˆå™¨èƒ½æ‰“å¼€)
â–¡ ç½‘ç»œè¿æ¥æ­£å¸¸
â–¡ é˜²ç«å¢™å…è®¸è®¿é—®
â–¡ APIæœåŠ¡æ­£åœ¨è¿è¡Œ
```

### å¸¸è§é…ç½®ç¤ºä¾‹
```
æ­£ç¡®çš„APIåœ°å€:
âœ… https://api.wuyinkeji.com
âœ… https://api.example.com/v1

é”™è¯¯çš„APIåœ°å€:
âŒ api.wuyinkeji.com (ç¼ºå°‘åè®®)
âŒ https://api.wuyinkeji.com/ (å¤šä½™çš„æ–œæ )
âŒ http://api.wuyinkeji.com (åº”è¯¥ä½¿ç”¨HTTPS)
```

### æµ‹è¯•æ­¥éª¤
1. **å¡«å†™é…ç½®**: ç¡®ä¿APIå¯†é’¥å’Œåœ°å€éƒ½å·²å¡«å†™
2. **ä¿å­˜è®¾ç½®**: å…ˆä¿å­˜é…ç½®å†æµ‹è¯•
3. **ç‚¹å‡»æµ‹è¯•**: ç‚¹å‡»"æµ‹è¯•APIè¿æ¥"æŒ‰é’®
4. **æŸ¥çœ‹ç»“æœ**: ä»”ç»†é˜…è¯»æµ‹è¯•ç»“æœä¿¡æ¯
5. **æ ¹æ®æç¤º**: æŒ‰ç…§é”™è¯¯æç¤ºè¿›è¡Œè°ƒæ•´

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### å“åº”æ—¶é—´ä¼˜åŒ–
- âš¡ **10ç§’è¶…æ—¶**: é¿å…é•¿æ—¶é—´ç­‰å¾…
- âš¡ **æ—©æœŸéªŒè¯**: æµ‹è¯•å‰éªŒè¯å¿…å¡«å­—æ®µ
- âš¡ **ç¼“å­˜ç»“æœ**: æˆåŠŸæµ‹è¯•åç¼“å­˜é…ç½®çŠ¶æ€
- âš¡ **å¹¶å‘æ§åˆ¶**: é˜²æ­¢åŒæ—¶å¤šä¸ªæµ‹è¯•è¯·æ±‚

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- ğŸ¨ **åŠ è½½çŠ¶æ€**: æ¸…æ™°çš„æµ‹è¯•è¿›åº¦æ˜¾ç¤º
- ğŸ¨ **è¯¦ç»†åé¦ˆ**: åŒ…å«è¯Šæ–­ä¿¡æ¯çš„ç»“æœ
- ğŸ¨ **æ“ä½œæŒ‡å¯¼**: å¤±è´¥æ—¶æä¾›è§£å†³å»ºè®®
- ğŸ¨ **é˜²è¯¯æ“ä½œ**: æµ‹è¯•æœŸé—´ç¦ç”¨æŒ‰é’®

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### APIå¯†é’¥ä¿æŠ¤
```typescript
// æ—¥å¿—ä¸­éšè—æ•æ„Ÿä¿¡æ¯
logger.info("APIè¿æ¥æµ‹è¯•", {
  api_url,
  api_key: api_key ? `${api_key.substring(0, 8)}...` : 'empty'
})
```

### é”™è¯¯ä¿¡æ¯è¿‡æ»¤
```typescript
// é¿å…æ³„éœ²æ•æ„Ÿçš„æœåŠ¡å™¨ä¿¡æ¯
const safeErrorMessage = errorText
  .replace(/password/gi, '[HIDDEN]')
  .replace(/token/gi, '[HIDDEN]')
  .replace(/key/gi, '[HIDDEN]')
```

### è¯·æ±‚é™åˆ¶
```typescript
// é˜²æ­¢APIæµ‹è¯•è¢«æ»¥ç”¨
const lastTestTime = Date.now()
if (lastTestTime - previousTestTime < 5000) {
  return createErrorResponse(Errors.TOO_MANY_REQUESTS, "è¯·ç­‰å¾…5ç§’åå†æ¬¡æµ‹è¯•")
}
```

## ğŸ‰ ä¿®å¤æˆæœ

### æŠ€æœ¯æ”¹è¿›
- ğŸ”§ **å¥å£®çš„å“åº”å¤„ç†**: æ”¯æŒJSONå’ŒHTMLå“åº”
- ğŸ”§ **è¯¦ç»†çš„é”™è¯¯è¯Šæ–­**: è¯†åˆ«å¸¸è§é—®é¢˜ç±»å‹
- ğŸ”§ **å®Œå–„çš„æ—¥å¿—è®°å½•**: ä¾¿äºé—®é¢˜æ’æŸ¥
- ğŸ”§ **ç”¨æˆ·å‹å¥½çš„åé¦ˆ**: æä¾›è§£å†³å»ºè®®

### ç”¨æˆ·ä½“éªŒæå‡
- ğŸ˜Š **æ¸…æ™°çš„æˆåŠŸä¿¡æ¯**: åŒ…å«è¯¦ç»†çš„è¿æ¥çŠ¶æ€
- ğŸ˜Š **æœ‰ç”¨çš„é”™è¯¯æç¤º**: æŒ‡å¯¼ç”¨æˆ·è§£å†³é—®é¢˜
- ğŸ˜Š **ç›´è§‚çš„åŠ è½½çŠ¶æ€**: æµ‹è¯•è¿‡ç¨‹å¯è§†åŒ–
- ğŸ˜Š **ä¸“ä¸šçš„ç•Œé¢è®¾è®¡**: ç¬¦åˆç®¡ç†åå°é£æ ¼

### ç³»ç»Ÿç¨³å®šæ€§
- ğŸ›¡ï¸ **å¼‚å¸¸å¤„ç†å®Œå–„**: è¦†ç›–æ‰€æœ‰å¯èƒ½çš„é”™è¯¯æƒ…å†µ
- ğŸ›¡ï¸ **è¶…æ—¶æ§åˆ¶**: é¿å…æ— é™ç­‰å¾…
- ğŸ›¡ï¸ **èµ„æºç®¡ç†**: æ­£ç¡®æ¸…ç†å®šæ—¶å™¨å’Œæ§åˆ¶å™¨
- ğŸ›¡ï¸ **çŠ¶æ€ä¸€è‡´æ€§**: ç¡®ä¿UIçŠ¶æ€æ­£ç¡®æ›´æ–°

---

**ğŸ‰ APIæµ‹è¯•åŠŸèƒ½å·²è¾¾åˆ°ç”Ÿäº§çº§æ ‡å‡†ï¼**

**ç‰¹ç‚¹**:
- ğŸ” **æ™ºèƒ½è¯Šæ–­**: è‡ªåŠ¨è¯†åˆ«å¸¸è§é—®é¢˜ç±»å‹
- ğŸ› ï¸ **è¯¦ç»†åé¦ˆ**: æä¾›å…·ä½“çš„è§£å†³å»ºè®®  
- ğŸš€ **ç¨³å®šå¯é **: å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- ğŸ¨ **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„æ“ä½œæŒ‡å¯¼

**ç°åœ¨å¯ä»¥å‡†ç¡®è¯Šæ–­APIè¿æ¥é—®é¢˜å¹¶æä¾›è§£å†³æ–¹æ¡ˆï¼**

