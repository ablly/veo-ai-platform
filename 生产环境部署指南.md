# VEO AI 平台 - 生产环境部署指南

> **商用级部署文档 | Production-Ready Deployment Guide**

---

## 📋 目录

1. [系统要求](#系统要求)
2. [服务器准备](#服务器准备)
3. [环境变量配置](#环境变量配置)
4. [数据库部署](#数据库部署)
5. [应用部署](#应用部署)
6. [Nginx配置](#nginx配置)
7. [SSL证书](#ssl证书)
8. [进程守护](#进程守护)
9. [监控和日志](#监控和日志)
10. [备份策略](#备份策略)
11. [故障排查](#故障排查)

---

## 系统要求

### 最低配置
- **CPU**: 2核
- **内存**: 4GB RAM
- **存储**: 40GB SSD
- **带宽**: 5Mbps

### 推荐配置（500+ 并发用户）
- **CPU**: 4核+
- **内存**: 8GB+ RAM
- **存储**: 100GB+ SSD
- **带宽**: 20Mbps+

### 软件要求
- **操作系统**: Ubuntu 22.04 LTS / CentOS 8+ / Debian 11+
- **Node.js**: 18.x 或 20.x
- **PostgreSQL**: 14+ 或 Supabase
- **Nginx**: 1.18+
- **PM2**: 最新版本
- **SSL证书**: Let's Encrypt（免费）或商业证书

---

## 服务器准备

### 1. 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. 安装Node.js

```bash
# 使用NodeSource安装Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node --version
npm --version
```

### 3. 安装PostgreSQL（如果不使用Supabase）

```bash
# Ubuntu/Debian
sudo apt install -y postgresql postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库
sudo -u postgres psql
CREATE DATABASE veo_production;
CREATE USER veo_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE veo_production TO veo_user;
\q
```

### 4. 安装Nginx

```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 5. 安装PM2（进程管理器）

```bash
sudo npm install -g pm2
```

---

## 环境变量配置

### 创建生产环境 `.env` 文件

```bash
cd /var/www/veo-ai-platform
nano .env.production
```

### 完整环境变量配置

```env
# ========================
# 应用基础配置
# ========================
NODE_ENV=production
NEXTAUTH_URL=https://yourdomain.com
NEXTAUTH_SECRET=your_super_secret_key_here_min_32_chars

# ========================
# 数据库配置
# ========================
DATABASE_URL=postgresql://veo_user:your_password@localhost:5432/veo_production

# ========================
# Supabase配置
# ========================
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_KEY=your_service_role_key

# ========================
# VEO API配置
# ========================
VEO_API_URL=https://api.veo3api.ai/api/v1
VEO_API_KEY=your_veo_api_key

# ========================
# 支付宝支付配置（备案后配置）
# ========================
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nYour_Private_Key_Here\n-----END RSA PRIVATE KEY-----"
ALIPAY_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\nAlipay_Public_Key_Here\n-----END PUBLIC KEY-----"
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do

# ========================
# VivaAPI配置
# ========================
VIVA_API_URL=https://www.vivaapi.cn/api
VIVA_API_TOKEN=your_viva_api_token

# ========================
# 邮件配置
# ========================
RESEND_API_KEY=your_resend_api_key
FROM_EMAIL=noreply@yourdomain.com

# ========================
# 安全配置
# ========================
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# ========================
# 日志和监控
# ========================
LOG_LEVEL=info
SENTRY_DSN=your_sentry_dsn (可选)
```

### 环境变量安全提示

⚠️ **重要安全事项**:
1. **绝对不要**将 `.env` 文件提交到Git
2. 使用强密码（至少32位随机字符）
3. 定期轮换密钥
4. 使用环境变量管理服务（如：AWS Secrets Manager, Vault）

---

## 数据库部署

### 1. 运行数据库迁移

```bash
# 如果使用Supabase，已自动应用迁移
# 如果使用本地PostgreSQL，手动执行SQL文件

psql -U veo_user -d veo_production -f database/schema.sql
```

### 2. 验证数据库连接

```bash
# 测试连接
psql -U veo_user -d veo_production -c "SELECT version();"
```

### 3. 数据库性能优化

```sql
-- 连接到数据库
psql -U veo_user -d veo_production

-- 优化配置（根据服务器规格调整）
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET max_connections = '200';

-- 重启PostgreSQL使配置生效
\q
sudo systemctl restart postgresql
```

---

## 应用部署

### 1. 克隆代码到服务器

```bash
# 创建应用目录
sudo mkdir -p /var/www
cd /var/www

# 克隆代码（使用Git或上传压缩包）
git clone https://github.com/your-repo/veo-ai-platform.git
cd veo-ai-platform
```

### 2. 安装依赖

```bash
# 安装生产依赖
npm install --production

# 或使用yarn
yarn install --production
```

### 3. 构建应用

```bash
# Next.js构建
npm run build

# 验证构建
ls -la .next
```

### 4. 配置PM2

创建 `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [{
    name: 'veo-ai-platform',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    cwd: '/var/www/veo-ai-platform',
    instances: 'max', // 使用所有CPU核心
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/veo/error.log',
    out_file: '/var/log/veo/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_memory_restart: '1G',
    autorestart: true,
    watch: false
  }]
}
```

### 5. 启动应用

```bash
# 创建日志目录
sudo mkdir -p /var/log/veo

# 启动PM2
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs veo-ai-platform

# 设置开机自启
pm2 startup
pm2 save
```

---

## Nginx配置

### 1. 创建Nginx配置文件

```bash
sudo nano /etc/nginx/sites-available/veo-ai-platform
```

### 2. Nginx配置内容

```nginx
# 限流配置
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# 缓存配置
proxy_cache_path /var/cache/nginx/veo levels=1:2 keys_zone=veo_cache:10m max_size=100m inactive=60m;

upstream veo_app {
    least_conn;
    server localhost:3000 max_fails=3 fail_timeout=30s;
    # 如果有多个实例，添加更多server
    # server localhost:3001 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # HTTP重定向到HTTPS（SSL证书配置后启用）
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 最大上传大小
    client_max_body_size 100M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # 静态文件缓存
    location /_next/static/ {
        proxy_pass http://veo_app;
        proxy_cache veo_cache;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, immutable, max-age=604800";
    }

    # API接口限流
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;
        
        proxy_pass http://veo_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # 主应用
    location / {
        proxy_pass http://veo_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 3. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/veo-ai-platform /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

---

## SSL证书

### 使用Let's Encrypt（免费，推荐）

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书（自动配置Nginx）
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 测试自动续期
sudo certbot renew --dry-run

# Certbot会自动设置cron定期续期
```

### 手动配置SSL证书

如果使用商业证书，将证书文件放置到:
- 证书: `/etc/ssl/certs/yourdomain.crt`
- 私钥: `/etc/ssl/private/yourdomain.key`

---

## 监控和日志

### 1. PM2监控

```bash
# 查看实时监控
pm2 monit

# 查看日志
pm2 logs

# 只查看错误日志
pm2 logs --err

# 导出日志
pm2 logs --json > logs.json
```

### 2. 系统监控

```bash
# 安装htop
sudo apt install -y htop

# 查看系统资源
htop

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

### 3. Nginx日志

```bash
# 访问日志
tail -f /var/log/nginx/access.log

# 错误日志
tail -f /var/log/nginx/error.log
```

### 4. 设置日志轮转

创建 `/etc/logrotate.d/veo`:

```
/var/log/veo/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

---

## 备份策略

### 1. 数据库备份

创建备份脚本 `/root/backup-db.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/veo"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="veo_production"

mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U veo_user $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# 删除30天前的备份
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +30 -delete

echo "Database backup completed: db_$DATE.sql.gz"
```

### 2. 设置自动备份

```bash
# 添加到crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /root/backup-db.sh >> /var/log/veo/backup.log 2>&1
```

### 3. 备份到云存储（可选）

```bash
# 使用rclone同步到阿里云OSS/腾讯云COS
rclone sync /var/backups/veo remote:veo-backups
```

---

## 故障排查

### 常见问题

#### 1. 应用无法启动

```bash
# 检查PM2状态
pm2 status

# 查看错误日志
pm2 logs --err

# 检查端口占用
sudo netstat -nltp | grep 3000

# 检查环境变量
pm2 env 0
```

#### 2. 数据库连接失败

```bash
# 测试数据库连接
psql -U veo_user -d veo_production -c "SELECT 1;"

# 检查PostgreSQL状态
sudo systemctl status postgresql

# 查看数据库日志
sudo tail -f /var/log/postgresql/postgresql-14-main.log
```

#### 3. Nginx 502错误

```bash
# 检查应用是否运行
pm2 status

# 检查Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 重启Nginx
sudo systemctl restart nginx
```

#### 4. 内存不足

```bash
# 查看内存使用
free -h

# 查看进程内存
pm2 list

# 设置PM2内存限制
pm2 start ecosystem.config.js --max-memory-restart 1G

# 增加swap（临时）
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

---

## 性能优化建议

### 1. Node.js优化

```bash
# 增加Node.js内存限制
export NODE_OPTIONS="--max-old-space-size=2048"
```

### 2. PostgreSQL优化

```sql
-- 查看慢查询
SELECT query, calls, total_time, mean_time 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;

-- 分析表
ANALYZE users;
ANALYZE credit_orders;
ANALYZE video_generations;
```

### 3. 缓存策略

- 使用Redis缓存频繁查询的数据
- 启用Nginx缓存静态资源
- 使用CDN加速图片和视频

---

## 安全检查清单

✅ **部署前检查**:

- [ ] 所有密码已更新为强密码
- [ ] `.env` 文件权限设置为 600
- [ ] 数据库只允许本地访问
- [ ] 防火墙已配置（只开放80, 443端口）
- [ ] SSH使用密钥登录，禁用密码登录
- [ ] 定期更新系统和依赖
- [ ] 已配置SSL证书
- [ ] 已设置自动备份
- [ ] 已配置监控和告警
- [ ] 已进行压力测试

---

## 支持和联系

如遇到部署问题，请：
1. 查看日志：`pm2 logs`
2. 检查错误文档
3. 联系技术支持

---

**部署完成后，请访问：**
- **生产地址**: https://yourdomain.com
- **健康检查**: https://yourdomain.com/health
- **管理后台**: https://yourdomain.com/admin/redemption-codes

祝部署顺利！🚀



