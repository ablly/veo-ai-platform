# VEO AI å¹³å° - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

> **å•†ç”¨çº§éƒ¨ç½²æ–‡æ¡£ | Production-Ready Deployment Guide**

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
2. [æœåŠ¡å™¨å‡†å¤‡](#æœåŠ¡å™¨å‡†å¤‡)
3. [ç¯å¢ƒå˜é‡é…ç½®](#ç¯å¢ƒå˜é‡é…ç½®)
4. [æ•°æ®åº“éƒ¨ç½²](#æ•°æ®åº“éƒ¨ç½²)
5. [åº”ç”¨éƒ¨ç½²](#åº”ç”¨éƒ¨ç½²)
6. [Nginxé…ç½®](#nginxé…ç½®)
7. [SSLè¯ä¹¦](#sslè¯ä¹¦)
8. [è¿›ç¨‹å®ˆæŠ¤](#è¿›ç¨‹å®ˆæŠ¤)
9. [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
10. [å¤‡ä»½ç­–ç•¥](#å¤‡ä»½ç­–ç•¥)
11. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç³»ç»Ÿè¦æ±‚

### æœ€ä½é…ç½®
- **CPU**: 2æ ¸
- **å†…å­˜**: 4GB RAM
- **å­˜å‚¨**: 40GB SSD
- **å¸¦å®½**: 5Mbps

### æ¨èé…ç½®ï¼ˆ500+ å¹¶å‘ç”¨æˆ·ï¼‰
- **CPU**: 4æ ¸+
- **å†…å­˜**: 8GB+ RAM
- **å­˜å‚¨**: 100GB+ SSD
- **å¸¦å®½**: 20Mbps+

### è½¯ä»¶è¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS / CentOS 8+ / Debian 11+
- **Node.js**: 18.x æˆ– 20.x
- **PostgreSQL**: 14+ æˆ– Supabase
- **Nginx**: 1.18+
- **PM2**: æœ€æ–°ç‰ˆæœ¬
- **SSLè¯ä¹¦**: Let's Encryptï¼ˆå…è´¹ï¼‰æˆ–å•†ä¸šè¯ä¹¦

---

## æœåŠ¡å™¨å‡†å¤‡

### 1. æ›´æ–°ç³»ç»Ÿ

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. å®‰è£…Node.js

```bash
# ä½¿ç”¨NodeSourceå®‰è£…Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# éªŒè¯å®‰è£…
node --version
npm --version
```

### 3. å®‰è£…PostgreSQLï¼ˆå¦‚æœä¸ä½¿ç”¨Supabaseï¼‰

```bash
# Ubuntu/Debian
sudo apt install -y postgresql postgresql-contrib

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql

# åˆ›å»ºæ•°æ®åº“
sudo -u postgres psql
CREATE DATABASE veo_production;
CREATE USER veo_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE veo_production TO veo_user;
\q
```

### 4. å®‰è£…Nginx

```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 5. å®‰è£…PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰

```bash
sudo npm install -g pm2
```

---

## ç¯å¢ƒå˜é‡é…ç½®

### åˆ›å»ºç”Ÿäº§ç¯å¢ƒ `.env` æ–‡ä»¶

```bash
cd /var/www/veo-ai-platform
nano .env.production
```

### å®Œæ•´ç¯å¢ƒå˜é‡é…ç½®

```env
# ========================
# åº”ç”¨åŸºç¡€é…ç½®
# ========================
NODE_ENV=production
NEXTAUTH_URL=https://yourdomain.com
NEXTAUTH_SECRET=your_super_secret_key_here_min_32_chars

# ========================
# æ•°æ®åº“é…ç½®
# ========================
DATABASE_URL=postgresql://veo_user:your_password@localhost:5432/veo_production

# ========================
# Supabaseé…ç½®
# ========================
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_KEY=your_service_role_key

# ========================
# VEO APIé…ç½®
# ========================
VEO_API_URL=https://api.veo3api.ai/api/v1
VEO_API_KEY=your_veo_api_key

# ========================
# æ”¯ä»˜å®æ”¯ä»˜é…ç½®ï¼ˆå¤‡æ¡ˆåé…ç½®ï¼‰
# ========================
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nYour_Private_Key_Here\n-----END RSA PRIVATE KEY-----"
ALIPAY_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----\nAlipay_Public_Key_Here\n-----END PUBLIC KEY-----"
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do

# ========================
# VivaAPIé…ç½®
# ========================
VIVA_API_URL=https://www.vivaapi.cn/api
VIVA_API_TOKEN=your_viva_api_token

# ========================
# é‚®ä»¶é…ç½®
# ========================
RESEND_API_KEY=your_resend_api_key
FROM_EMAIL=noreply@yourdomain.com

# ========================
# å®‰å…¨é…ç½®
# ========================
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# ========================
# æ—¥å¿—å’Œç›‘æ§
# ========================
LOG_LEVEL=info
SENTRY_DSN=your_sentry_dsn (å¯é€‰)
```

### ç¯å¢ƒå˜é‡å®‰å…¨æç¤º

âš ï¸ **é‡è¦å®‰å…¨äº‹é¡¹**:
1. **ç»å¯¹ä¸è¦**å°† `.env` æ–‡ä»¶æäº¤åˆ°Git
2. ä½¿ç”¨å¼ºå¯†ç ï¼ˆè‡³å°‘32ä½éšæœºå­—ç¬¦ï¼‰
3. å®šæœŸè½®æ¢å¯†é’¥
4. ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æœåŠ¡ï¼ˆå¦‚ï¼šAWS Secrets Manager, Vaultï¼‰

---

## æ•°æ®åº“éƒ¨ç½²

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# å¦‚æœä½¿ç”¨Supabaseï¼Œå·²è‡ªåŠ¨åº”ç”¨è¿ç§»
# å¦‚æœä½¿ç”¨æœ¬åœ°PostgreSQLï¼Œæ‰‹åŠ¨æ‰§è¡ŒSQLæ–‡ä»¶

psql -U veo_user -d veo_production -f database/schema.sql
```

### 2. éªŒè¯æ•°æ®åº“è¿æ¥

```bash
# æµ‹è¯•è¿æ¥
psql -U veo_user -d veo_production -c "SELECT version();"
```

### 3. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

```sql
-- è¿æ¥åˆ°æ•°æ®åº“
psql -U veo_user -d veo_production

-- ä¼˜åŒ–é…ç½®ï¼ˆæ ¹æ®æœåŠ¡å™¨è§„æ ¼è°ƒæ•´ï¼‰
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET max_connections = '200';

-- é‡å¯PostgreSQLä½¿é…ç½®ç”Ÿæ•ˆ
\q
sudo systemctl restart postgresql
```

---

## åº”ç”¨éƒ¨ç½²

### 1. å…‹éš†ä»£ç åˆ°æœåŠ¡å™¨

```bash
# åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /var/www
cd /var/www

# å…‹éš†ä»£ç ï¼ˆä½¿ç”¨Gitæˆ–ä¸Šä¼ å‹ç¼©åŒ…ï¼‰
git clone https://github.com/your-repo/veo-ai-platform.git
cd veo-ai-platform
```

### 2. å®‰è£…ä¾èµ–

```bash
# å®‰è£…ç”Ÿäº§ä¾èµ–
npm install --production

# æˆ–ä½¿ç”¨yarn
yarn install --production
```

### 3. æ„å»ºåº”ç”¨

```bash
# Next.jsæ„å»º
npm run build

# éªŒè¯æ„å»º
ls -la .next
```

### 4. é…ç½®PM2

åˆ›å»º `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [{
    name: 'veo-ai-platform',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    cwd: '/var/www/veo-ai-platform',
    instances: 'max', // ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/veo/error.log',
    out_file: '/var/log/veo/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_memory_restart: '1G',
    autorestart: true,
    watch: false
  }]
}
```

### 5. å¯åŠ¨åº”ç”¨

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/veo

# å¯åŠ¨PM2
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs veo-ai-platform

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

---

## Nginxé…ç½®

### 1. åˆ›å»ºNginxé…ç½®æ–‡ä»¶

```bash
sudo nano /etc/nginx/sites-available/veo-ai-platform
```

### 2. Nginxé…ç½®å†…å®¹

```nginx
# é™æµé…ç½®
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ç¼“å­˜é…ç½®
proxy_cache_path /var/cache/nginx/veo levels=1:2 keys_zone=veo_cache:10m max_size=100m inactive=60m;

upstream veo_app {
    least_conn;
    server localhost:3000 max_fails=3 fail_timeout=30s;
    # å¦‚æœæœ‰å¤šä¸ªå®ä¾‹ï¼Œæ·»åŠ æ›´å¤šserver
    # server localhost:3001 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # HTTPé‡å®šå‘åˆ°HTTPSï¼ˆSSLè¯ä¹¦é…ç½®åå¯ç”¨ï¼‰
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # æœ€å¤§ä¸Šä¼ å¤§å°
    client_max_body_size 100M;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location /_next/static/ {
        proxy_pass http://veo_app;
        proxy_cache veo_cache;
        proxy_cache_valid 200 7d;
        add_header Cache-Control "public, immutable, max-age=604800";
    }

    # APIæ¥å£é™æµ
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;
        
        proxy_pass http://veo_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # ä¸»åº”ç”¨
    location / {
        proxy_pass http://veo_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### 3. å¯ç”¨é…ç½®

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/veo-ai-platform /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½Nginx
sudo systemctl reload nginx
```

---

## SSLè¯ä¹¦

### ä½¿ç”¨Let's Encryptï¼ˆå…è´¹ï¼Œæ¨èï¼‰

```bash
# å®‰è£…Certbot
sudo apt install -y certbot python3-certbot-nginx

# è·å–è¯ä¹¦ï¼ˆè‡ªåŠ¨é…ç½®Nginxï¼‰
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run

# Certbotä¼šè‡ªåŠ¨è®¾ç½®cronå®šæœŸç»­æœŸ
```

### æ‰‹åŠ¨é…ç½®SSLè¯ä¹¦

å¦‚æœä½¿ç”¨å•†ä¸šè¯ä¹¦ï¼Œå°†è¯ä¹¦æ–‡ä»¶æ”¾ç½®åˆ°:
- è¯ä¹¦: `/etc/ssl/certs/yourdomain.crt`
- ç§é’¥: `/etc/ssl/private/yourdomain.key`

---

## ç›‘æ§å’Œæ—¥å¿—

### 1. PM2ç›‘æ§

```bash
# æŸ¥çœ‹å®æ—¶ç›‘æ§
pm2 monit

# æŸ¥çœ‹æ—¥å¿—
pm2 logs

# åªæŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs --err

# å¯¼å‡ºæ—¥å¿—
pm2 logs --json > logs.json
```

### 2. ç³»ç»Ÿç›‘æ§

```bash
# å®‰è£…htop
sudo apt install -y htop

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
```

### 3. Nginxæ—¥å¿—

```bash
# è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/access.log

# é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log
```

### 4. è®¾ç½®æ—¥å¿—è½®è½¬

åˆ›å»º `/etc/logrotate.d/veo`:

```
/var/log/veo/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

---

## å¤‡ä»½ç­–ç•¥

### 1. æ•°æ®åº“å¤‡ä»½

åˆ›å»ºå¤‡ä»½è„šæœ¬ `/root/backup-db.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/veo"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="veo_production"

mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
pg_dump -U veo_user $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +30 -delete

echo "Database backup completed: db_$DATE.sql.gz"
```

### 2. è®¾ç½®è‡ªåŠ¨å¤‡ä»½

```bash
# æ·»åŠ åˆ°crontab
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /root/backup-db.sh >> /var/log/veo/backup.log 2>&1
```

### 3. å¤‡ä»½åˆ°äº‘å­˜å‚¨ï¼ˆå¯é€‰ï¼‰

```bash
# ä½¿ç”¨rcloneåŒæ­¥åˆ°é˜¿é‡Œäº‘OSS/è…¾è®¯äº‘COS
rclone sync /var/backups/veo remote:veo-backups
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. åº”ç”¨æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥PM2çŠ¶æ€
pm2 status

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs --err

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -nltp | grep 3000

# æ£€æŸ¥ç¯å¢ƒå˜é‡
pm2 env 0
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -U veo_user -d veo_production -c "SELECT 1;"

# æ£€æŸ¥PostgreSQLçŠ¶æ€
sudo systemctl status postgresql

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
sudo tail -f /var/log/postgresql/postgresql-14-main.log
```

#### 3. Nginx 502é”™è¯¯

```bash
# æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
pm2 status

# æ£€æŸ¥Nginxé…ç½®
sudo nginx -t

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# é‡å¯Nginx
sudo systemctl restart nginx
```

#### 4. å†…å­˜ä¸è¶³

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹è¿›ç¨‹å†…å­˜
pm2 list

# è®¾ç½®PM2å†…å­˜é™åˆ¶
pm2 start ecosystem.config.js --max-memory-restart 1G

# å¢åŠ swapï¼ˆä¸´æ—¶ï¼‰
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Node.jsä¼˜åŒ–

```bash
# å¢åŠ Node.jså†…å­˜é™åˆ¶
export NODE_OPTIONS="--max-old-space-size=2048"
```

### 2. PostgreSQLä¼˜åŒ–

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, calls, total_time, mean_time 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;

-- åˆ†æè¡¨
ANALYZE users;
ANALYZE credit_orders;
ANALYZE video_generations;
```

### 3. ç¼“å­˜ç­–ç•¥

- ä½¿ç”¨Redisç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®
- å¯ç”¨Nginxç¼“å­˜é™æ€èµ„æº
- ä½¿ç”¨CDNåŠ é€Ÿå›¾ç‰‡å’Œè§†é¢‘

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

âœ… **éƒ¨ç½²å‰æ£€æŸ¥**:

- [ ] æ‰€æœ‰å¯†ç å·²æ›´æ–°ä¸ºå¼ºå¯†ç 
- [ ] `.env` æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600
- [ ] æ•°æ®åº“åªå…è®¸æœ¬åœ°è®¿é—®
- [ ] é˜²ç«å¢™å·²é…ç½®ï¼ˆåªå¼€æ”¾80, 443ç«¯å£ï¼‰
- [ ] SSHä½¿ç”¨å¯†é’¥ç™»å½•ï¼Œç¦ç”¨å¯†ç ç™»å½•
- [ ] å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–
- [ ] å·²é…ç½®SSLè¯ä¹¦
- [ ] å·²è®¾ç½®è‡ªåŠ¨å¤‡ä»½
- [ ] å·²é…ç½®ç›‘æ§å’Œå‘Šè­¦
- [ ] å·²è¿›è¡Œå‹åŠ›æµ‹è¯•

---

## æ”¯æŒå’Œè”ç³»

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—ï¼š`pm2 logs`
2. æ£€æŸ¥é”™è¯¯æ–‡æ¡£
3. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**éƒ¨ç½²å®Œæˆåï¼Œè¯·è®¿é—®ï¼š**
- **ç”Ÿäº§åœ°å€**: https://yourdomain.com
- **å¥åº·æ£€æŸ¥**: https://yourdomain.com/health
- **ç®¡ç†åå°**: https://yourdomain.com/admin/redemption-codes

ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€



