# 支付宝企业应用配置完整指南

> **适用场景：** 已有企业资质（营业执照），需要在VEO AI平台接入支付宝支付功能

---

## 📋 目录

1. [准备工作](#准备工作)
2. [创建支付宝应用](#创建支付宝应用)
3. [生成应用密钥](#生成应用密钥)
4. [配置应用参数](#配置应用参数)
5. [申请产品能力](#申请产品能力)
6. [设置EdgeOne环境变量](#设置edgeone环境变量)
7. [测试支付功能](#测试支付功能)
8. [常见问题](#常见问题)

---

## 1️⃣ 准备工作

### 需要准备的材料

- ✅ 企业营业执照（扫描件或照片）
- ✅ 企业对公账户信息
- ✅ 法人身份证信息
- ✅ 企业联系人信息（手机号、邮箱）
- ✅ 网站域名：`www.veo-ai.site`

---

## 2️⃣ 创建支付宝应用

### 步骤1：登录支付宝开放平台

1. 访问：**https://open.alipay.com**
2. 使用企业支付宝账号登录
3. 完成企业实名认证（如果还未认证）

### 步骤2：创建网页/移动应用

1. 进入 **控制台** → **应用管理**
   
   ```
   https://open.alipay.com/platform/appManage.htm
   ```

2. 点击 **创建应用**

3. 选择应用类型：
   - ✅ **网页&移动应用**（推荐，支持PC和手机）
   - 或 **网页应用**（仅支持PC）

4. 填写应用信息：

   | 字段 | 填写内容 |
   |------|---------|
   | 应用名称 | `VEO AI视频创作平台` |
   | 应用英文名称 | `VEO AI Platform` |
   | 应用简介 | `基于AI的专业视频创作平台，提供视频生成和编辑服务` |
   | 应用图标 | 上传VEO AI的logo（128x128像素，PNG格式） |
   | 应用类型 | 网页&移动应用 |
   | 所属行业 | 互联网软件-在线视频/直播 |

5. 点击 **创建**

6. **记录应用的 APPID**（格式：`2021xxxxxxxxxx`）

   ```
   示例：2021006103667603
   ```

   ⚠️ **重要：请将APPID保存到记事本，后续配置需要用到！**

---

## 3️⃣ 生成应用密钥

支付宝使用RSA2加密算法保证支付安全，需要生成密钥对。

### 方式1：使用支付宝密钥生成工具（推荐）

#### Windows系统

1. **下载密钥生成工具**
   
   ```
   https://opendocs.alipay.com/common/02kipk
   ```
   
   直接下载：[Windows版本](https://ideservice.alipay.com/ide/getPluginUrl.htm?clientType=assistant&platform=win&channelType=WEB)

2. **解压并运行**
   
   - 解压 `支付宝开放平台开发助手.zip`
   - 双击运行 `支付宝开放平台开发助手.exe`

3. **生成密钥**
   
   - 选择 **RSA2(SHA256)密钥**（推荐）
   - 密钥格式：**PKCS1（非JAVA适用）**
   - 密钥长度：**2048**
   - 点击 **生成密钥**

4. **保存密钥**
   
   生成后会得到两个文件：
   
   - `应用私钥.txt` - **应用私钥（ALIPAY_PRIVATE_KEY）**
   - `应用公钥.txt` - 应用公钥（需要上传到支付宝）

   ⚠️ **重要：**
   - 应用私钥非常重要，请妥善保管，不要泄露！
   - 应用公钥需要上传到支付宝开放平台

#### Mac/Linux系统

使用OpenSSL命令生成：

```bash
# 生成应用私钥
openssl genrsa -out app_private_key.pem 2048

# 从私钥中提取应用公钥
openssl rsa -in app_private_key.pem -pubout -out app_public_key.pem

# 查看应用私钥（去掉头尾和换行）
cat app_private_key.pem | grep -v "BEGIN" | grep -v "END" | tr -d '\n'

# 查看应用公钥（去掉头尾和换行）
cat app_public_key.pem | grep -v "BEGIN" | grep -v "END" | tr -d '\n'
```

### 方式2：在线生成（不推荐，安全性较低）

⚠️ 不建议使用第三方在线工具生成密钥，可能存在安全风险。

---

## 4️⃣ 配置应用参数

### 步骤1：上传应用公钥

1. 进入 **应用详情** → **开发设置** → **接口加签方式**

2. 点击 **设置**

3. 选择 **公钥**

4. 将 `应用公钥.txt` 的内容（去掉头尾和换行）粘贴到输入框

   ```
   示例（仅供参考，请使用您自己生成的公钥）：
   
   MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
   ```

5. 点击 **保存**

6. **保存支付宝公钥**
   
   上传成功后，页面会显示 **支付宝公钥**
   
   点击 **复制** 按钮，将支付宝公钥保存到记事本
   
   ⚠️ **重要：这是 ALIPAY_PUBLIC_KEY，后续配置需要用到！**

### 步骤2：配置应用网关和授权回调地址

1. 在 **开发设置** 页面，找到 **接口内容加密方式**
   
   - 如果不需要加密敏感信息，选择 **不加密**
   - 如果需要加密，按提示配置AES密钥

2. 配置 **授权回调地址**（OAuth登录需要，支付不需要）
   
   - 如果不使用支付宝账号登录，可以暂时不配置

3. 配置 **应用网关**（异步通知接收地址）
   
   ⚠️ **重要：** 这是支付宝回调地址，必须配置！
   
   ```
   https://www.veo-ai.site/api/payment/alipay/notify
   ```

4. 点击 **保存**

---

## 5️⃣ 申请产品能力

您的应用创建完成后，需要申请 **电脑网站支付** 能力。

### 步骤1：进入功能列表

1. 在应用详情页，点击 **功能列表**

2. 找到 **电脑网站支付**（`alipay.trade.page.pay`）

3. 点击 **申请**

### 步骤2：填写申请信息

| 字段 | 填写内容 |
|------|---------|
| **应用场景** | 在线视频服务 |
| **业务描述** | VEO AI是一款基于人工智能的视频创作平台，用户可以通过平台生成AI视频，并购买积分套餐以使用更多服务。用户在选择套餐后，使用支付宝完成在线支付。 |
| **业务网站/APP名称** | VEO AI视频创作平台 |
| **网站地址** | https://www.veo-ai.site |
| **上传截图** | 需要上传4-6张截图（见下方说明） |

### 步骤3：准备并上传截图

需要上传以下页面截图（每张截图应包含网站URL和核心功能）：

1. **首页截图**
   - 访问 `https://www.veo-ai.site`
   - 截图整个首页（包含URL栏）

2. **套餐定价页面**
   - 访问 `https://www.veo-ai.site/pricing`
   - 截图套餐列表和价格

3. **视频生成页面**
   - 访问 `https://www.veo-ai.site/generate`
   - 截图视频生成界面

4. **用户协议/服务条款**
   - 访问 `https://www.veo-ai.site/terms`
   - 截图条款内容

5. **支付流程截图**（可选）
   - 模拟选择套餐 → 点击购买的流程
   - 截图购买按钮和支付页面

6. **企业资质**
   - 上传营业执照扫描件

### 步骤4：提交审核

1. 确认所有信息填写完整

2. 点击 **提交审核**

3. **审核时间：** 通常1-3个工作日

4. **审核结果：** 会通过短信和邮件通知

---

## 6️⃣ 设置EdgeOne环境变量

审核通过后，您需要将支付宝配置信息添加到EdgeOne环境变量。

### 需要配置的环境变量

| 环境变量名 | 说明 | 获取位置 | 示例值 |
|-----------|------|---------|--------|
| `ALIPAY_APP_ID` | 支付宝应用ID | 应用详情页 | `2021006103667603` |
| `ALIPAY_PRIVATE_KEY` | 应用私钥 | 本地生成的 `应用私钥.txt` | `MIIEvQIBADANBg...` |
| `ALIPAY_PUBLIC_KEY` | 支付宝公钥 | 应用详情→开发设置→接口加签方式 | `MIIBIjANBgkqh...` |
| `ALIPAY_GATEWAY` | 支付宝网关 | 固定值 | `https://openapi.alipay.com/gateway.do` |
| `ALIPAY_SIGN_TYPE` | 签名类型 | 固定值 | `RSA2` |
| `ALIPAY_CHARSET` | 字符集 | 固定值 | `utf-8` |

### 配置步骤

#### 方法1：在EdgeOne控制台手动添加

1. **登录EdgeOne控制台**
   
   ```
   https://console.cloud.tencent.com/edgeone
   ```

2. **进入您的站点** → **Pages服务** → 选择您的项目

3. **点击设置** → **环境变量**

4. **逐个添加环境变量**
   
   点击 **新增环境变量**，填写：
   
   - **变量名：** `ALIPAY_APP_ID`
   - **变量值：** `您的支付宝应用ID`
   - 点击 **确定**
   
   重复此步骤，添加所有6个环境变量

5. **保存并重新部署**
   
   - 点击 **保存**
   - EdgeOne会自动触发重新部署

#### 方法2：使用EdgeOne CLI（命令行）

如果您安装了EdgeOne CLI，可以批量添加：

```bash
# 设置环境变量（请替换为您的实际值）
edgeone env:set ALIPAY_APP_ID=2021006103667603
edgeone env:set ALIPAY_PRIVATE_KEY="MIIEvQIBADANBg..."
edgeone env:set ALIPAY_PUBLIC_KEY="MIIBIjANBgkqh..."
edgeone env:set ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
edgeone env:set ALIPAY_SIGN_TYPE=RSA2
edgeone env:set ALIPAY_CHARSET=utf-8

# 触发重新部署
edgeone deploy
```

### ⚠️ 注意事项

1. **应用私钥格式**
   
   应用私钥应该是一行，去掉了 `-----BEGIN RSA PRIVATE KEY-----` 和 `-----END RSA PRIVATE KEY-----`
   
   ✅ 正确格式（一行，无空格无换行）：
   ```
   MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
   ```
   
   ❌ 错误格式（包含头尾和换行）：
   ```
   -----BEGIN RSA PRIVATE KEY-----
   MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
   ...
   -----END RSA PRIVATE KEY-----
   ```

2. **支付宝公钥格式**
   
   同样需要去掉头尾和换行，保持一行

3. **环境变量生效时间**
   
   EdgeOne修改环境变量后，需要等待1-5分钟部署完成才会生效

---

## 7️⃣ 测试支付功能

配置完成后，测试支付宝支付是否正常工作。

### 步骤1：使用沙箱环境测试（可选）

支付宝提供了沙箱环境用于开发测试：

1. 进入 **支付宝沙箱环境**
   
   ```
   https://open.alipay.com/platform/appManage.htm#/apps
   ```
   
   点击 **沙箱** 标签

2. 查看沙箱应用信息
   
   - 沙箱APPID
   - 沙箱密钥
   - 沙箱账号

3. 配置沙箱环境变量（仅用于测试）
   
   将 `ALIPAY_GATEWAY` 修改为沙箱网关：
   ```
   https://openapi-sandbox.dl.alipaydev.com/gateway.do
   ```

4. 使用沙箱账号测试支付流程

### 步骤2：生产环境测试

⚠️ **重要：** 生产环境测试会产生真实订单和扣款，请谨慎操作！

1. **访问您的网站**
   
   ```
   https://www.veo-ai.site
   ```

2. **登录账号**

3. **进入套餐页面**
   
   ```
   https://www.veo-ai.site/pricing
   ```

4. **选择一个低价套餐**（建议选择最便宜的进行测试）

5. **点击"立即购买"**

6. **检查订单创建**
   
   - 是否成功跳转到支付宝收银台
   - 订单金额是否正确
   - 订单描述是否正确

7. **完成支付**
   
   - 使用支付宝扫码或登录支付
   - 支付成功后，检查是否跳转回网站
   - 检查积分是否到账

8. **查看后台日志**
   
   - 检查EdgeOne日志，确认支付回调是否正常
   - 查看数据库，确认订单状态是否更新为"已支付"

### 常见测试场景

| 测试场景 | 预期结果 |
|---------|---------|
| 创建订单 | 成功生成订单号，跳转到支付宝收银台 |
| 支付成功 | 支付宝回调通知，订单状态更新为已支付，积分到账 |
| 支付失败 | 订单状态保持为待支付，用户可重新支付 |
| 超时未支付 | 30分钟后订单自动关闭 |
| 重复支付 | 系统检测到已支付，不重复发放积分 |
| 退款 | 支付宝原路退款，积分扣除 |

---

## 8️⃣ 常见问题

### Q1: 应用审核被拒绝怎么办？

**常见拒绝原因：**

1. **网站无法访问**
   - 确保网站已部署且可正常访问
   - 检查HTTPS证书是否有效

2. **业务描述不清晰**
   - 详细描述业务流程和支付场景
   - 说明用户如何使用、如何支付

3. **截图不符合要求**
   - 截图需要包含网站URL
   - 截图需要清晰展示业务流程
   - 至少上传4张不同页面的截图

4. **企业资质不完整**
   - 上传完整的营业执照
   - 确保营业执照在有效期内

**解决方法：**
- 根据拒绝原因修改后重新提交
- 联系支付宝客服咨询具体原因

### Q2: 支付时报"应用未签约"错误

**原因：** 应用能力审核未通过或未签约

**解决方法：**

1. 检查 **功能列表** 中"电脑网站支付"的状态
2. 如果是"未签约"，点击 **签约**
3. 如果是"审核中"，等待审核通过

### Q3: 支付后回调通知收不到

**可能原因：**

1. **回调地址配置错误**
   - 检查应用网关地址是否正确
   - 确保 `https://www.veo-ai.site/api/payment/alipay/notify` 可访问

2. **签名验证失败**
   - 检查应用私钥和支付宝公钥是否正确
   - 检查签名算法是否为RSA2

3. **服务器无法访问**
   - 检查EdgeOne部署状态
   - 检查服务器防火墙设置

**调试方法：**

1. 查看支付宝开放平台 **消息管理** → **通知记录**
2. 检查EdgeOne日志
3. 使用支付宝提供的 **接口调试工具** 测试

### Q4: 支付宝公钥和应用公钥有什么区别？

- **应用公钥：** 您生成并上传到支付宝的公钥，支付宝用它来验证您的签名
- **支付宝公钥：** 支付宝提供的公钥，您用它来验证支付宝的回调签名

**使用：**
- `ALIPAY_PRIVATE_KEY`：您的应用私钥，用于生成签名
- `ALIPAY_PUBLIC_KEY`：支付宝的公钥，用于验证支付宝回调

### Q5: 如何切换沙箱和生产环境？

**沙箱环境配置：**

```bash
ALIPAY_APP_ID=沙箱APPID
ALIPAY_GATEWAY=https://openapi-sandbox.dl.alipaydev.com/gateway.do
ALIPAY_PRIVATE_KEY=沙箱应用私钥
ALIPAY_PUBLIC_KEY=沙箱支付宝公钥
```

**生产环境配置：**

```bash
ALIPAY_APP_ID=正式APPID
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
ALIPAY_PRIVATE_KEY=正式应用私钥
ALIPAY_PUBLIC_KEY=正式支付宝公钥
```

### Q6: 应用私钥泄露了怎么办？

⚠️ **非常危险！** 应用私钥泄露可能导致资金安全问题！

**立即处理：**

1. **停用旧密钥**
   - 登录支付宝开放平台
   - 进入应用详情 → 开发设置
   - 删除旧的应用公钥

2. **重新生成密钥对**
   - 使用密钥生成工具生成新的密钥对
   - 上传新的应用公钥到支付宝

3. **更新环境变量**
   - 在EdgeOne中更新 `ALIPAY_PRIVATE_KEY`
   - 更新 `ALIPAY_PUBLIC_KEY`（如果支付宝公钥也变了）

4. **监控异常交易**
   - 检查是否有异常订单
   - 联系支付宝客服报备

### Q7: 如何查看支付宝交易记录？

1. **登录支付宝开放平台**
   
   ```
   https://open.alipay.com
   ```

2. **进入应用详情** → **交易管理** → **交易记录**

3. **查看订单详情**
   - 订单号
   - 交易金额
   - 交易状态
   - 买家信息

4. **导出对账单**
   - 每月1-3号可下载上月对账单
   - 用于财务对账

### Q8: 支付宝手续费是多少？

**费率说明：**

- **标准费率：** 0.6%（千分之六）
- **优惠费率：** 根据行业和交易量可能有优惠，具体咨询支付宝商务

**计算示例：**
```
用户支付100元 → 到账 = 100 - (100 × 0.6%) = 99.4元
平台收入99.4元，手续费0.6元
```

**费率查询：**
1. 登录支付宝开放平台
2. 进入 **账户管理** → **费率查询**

---

## 📞 技术支持

### 支付宝官方文档

- **开发者文档：** https://opendocs.alipay.com/open
- **电脑网站支付：** https://opendocs.alipay.com/open/270
- **API参考：** https://opendocs.alipay.com/open/api

### 支付宝客服

- **技术支持论坛：** https://forum.alipay.com
- **在线客服：** 支付宝开放平台右下角在线咨询
- **电话客服：** 95188（选择商家服务）

### VEO AI技术支持

如果配置过程中遇到问题，请检查：

1. EdgeOne部署日志
2. 数据库订单记录
3. 浏览器控制台错误

---

## ✅ 配置检查清单

在完成配置后，请确认以下事项：

- [ ] 支付宝应用已创建，记录了APPID
- [ ] 已生成RSA2密钥对（应用私钥和应用公钥）
- [ ] 应用公钥已上传到支付宝
- [ ] 已获取并保存支付宝公钥
- [ ] 应用网关地址已配置：`https://www.veo-ai.site/api/payment/alipay/notify`
- [ ] "电脑网站支付"能力已申请并审核通过
- [ ] EdgeOne环境变量已配置完整（6个变量）
- [ ] EdgeOne已重新部署
- [ ] 测试订单创建成功
- [ ] 测试支付流程完整
- [ ] 支付回调正常接收
- [ ] 积分正确到账

---

## 🎉 配置完成

恭喜！完成以上所有步骤后，您的VEO AI平台已成功接入支付宝支付功能！

用户现在可以通过支付宝购买积分套餐，享受AI视频创作服务了！

---

**文档版本：** v1.0  
**更新时间：** 2025-10-29  
**适用平台：** VEO AI Platform


