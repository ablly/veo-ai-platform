# 混合模式（方案C）- 通俗图解

> **5分钟看懂自动化流程**

---

## 🎯 核心思想：共享充值卡模式

**把VivaAPI想象成：充话费的充值卡**

---

## 📖 故事化解释

### **传统线下店铺模式**

想象您开了一家**奶茶店**：

1. **您去批发市场**：花¥1000买了很多原料（茶叶、牛奶等）
2. **客户来买奶茶**：客户付¥20买一杯奶茶
3. **您用原料做奶茶**：从库存中取原料制作
4. **记录库存**：记下用了多少原料
5. **定期补货**：原料快用完了再去批发市场补货

**混合模式就是这个逻辑！**

---

## 🔄 混合模式完整流程图

```
┌─────────────────────────────────────────────────────────┐
│  第1步：您准备"原料"（VivaAPI充值）                      │
└─────────────────────────────────────────────────────────┘
                           ↓
              ┌──────────────────────┐
              │  您的VivaAPI账号      │
              │  余额：¥1000         │  ← 这是您的"原料库"
              └──────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│  第2步：用户购买套餐                                     │
└─────────────────────────────────────────────────────────┘
                           ↓
         用户A付款¥49 → 支付宝支付成功
                           ↓
              ┌──────────────────────┐
              │  您的数据库记录       │
              │  用户A: 50积分       │  ← 记账本
              └──────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│  第3步：用户生成视频                                     │
└─────────────────────────────────────────────────────────┘
                           ↓
         用户A点击"生成视频"
                           ↓
        系统检查：用户A有50积分 ✅
                           ↓
        扣减积分：50 - 15 = 35积分
                           ↓
        使用您的VivaAPI充值卡调用API
                           ↓
        记录使用：user_viva_api_keys表 +15
                           ↓
              ┌──────────────────────┐
              │  更新后的数据库       │
              │  用户A: 35积分       │
              │  已使用: 15积分      │
              └──────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│  第4步：定期结算（每周/每月）                            │
└─────────────────────────────────────────────────────────┘
                           ↓
        查询总使用量：500积分
                           ↓
        成本：500 × ¥0.25 = ¥125
                           ↓
        补充VivaAPI充值：¥125
```

---

## 💰 真实案例

### **场景：您的第一个月运营**

#### **月初准备**
```
您的操作：
  1. 注册VivaAPI账号
  2. 充值¥500到VivaAPI
  3. 获得Token，配置到系统

VivaAPI余额：¥500
```

#### **第1周：第一批用户**
```
用户购买：
  • 用户A: ¥49 → 50积分
  • 用户B: ¥99 → 150积分
  • 用户C: ¥49 → 50积分

您的收入：¥49 + ¥99 + ¥49 = ¥197
数据库记录：
  • 用户A: 50积分
  • 用户B: 150积分
  • 用户C: 50积分
```

#### **第2周：用户开始使用**
```
视频生成：
  • 用户A生成2个视频 → 消耗30积分
  • 用户B生成5个视频 → 消耗75积分
  • 用户C生成1个视频 → 消耗15积分

总消耗：120积分
VivaAPI实际成本：120 × ¥0.25 = ¥30
VivaAPI余额：¥500 - ¥30 = ¥470

数据库更新：
  • 用户A: 剩余20积分
  • 用户B: 剩余75积分
  • 用户C: 剩余35积分
```

#### **月末统计**
```
总收入：¥197
总成本：¥30（VivaAPI）
毛利润：¥167
利润率：85%

VivaAPI余额：¥470（还很充足，下月继续用）
```

---

## 🔑 关键数据表

### **user_credit_accounts（用户积分账户）**
```
用户视角："我有多少积分"

| user_id | available_credits | total_credits | used_credits |
|---------|-------------------|---------------|--------------|
| A       | 20                | 50            | 30           |
| B       | 75                | 150           | 75           |
| C       | 35                | 50            | 15           |
```

### **user_viva_api_keys（VivaAPI使用记录）**
```
运营视角："总共用了多少VivaAPI"

| user_id | quota | used | api_key |
|---------|-------|------|---------|
| A       | 50    | 30   | 您的主Token |
| B       | 150   | 75   | 您的主Token |
| C       | 50    | 15   | 您的主Token |

总计使用：30 + 75 + 15 = 120积分 = ¥30成本
```

---

## ✅ 混合模式的优势

### **1. 简单直接**
- ❌ 不需要：为每个用户创建VivaAPI子账号
- ✅ 只需要：一个主Token，所有用户共用
- ✅ 您的数据库管理谁用了多少

### **2. 成本清晰**
```sql
-- 随时查询总成本
SELECT SUM(used) * 0.25 as total_cost FROM user_viva_api_keys;

-- 查询利润
SELECT 
  SUM(amount) as revenue,           -- 总收入
  SUM(used) * 0.25 as cost,        -- 总成本
  SUM(amount) - SUM(used) * 0.25 as profit  -- 利润
FROM credit_orders;
```

### **3. 灵活控制**
- 您决定何时补充VivaAPI余额
- 可以设置告警：余额低于¥100时通知
- 可以批量充值享受优惠

### **4. 安全可靠**
- 用户永远看不到VivaAPI Token
- 所有请求都在服务器端
- 数据库完全控制权限

---

## 🚫 常见误区

### **误区1："是不是每个用户要单独买VivaAPI账号？"**
❌ **不需要！**  
✅ 所有用户共用您的一个VivaAPI账号（就像所有客户用您店里的同一批原料）

### **误区2："用户能看到我的VivaAPI Token吗？"**
❌ **看不到！**  
✅ Token存在服务器`.env`文件中，用户永远访问不到

### **误区3："如果VivaAPI余额用完了怎么办？"**
🔔 **系统会告警**  
✅ 您可以设置监控，余额低于阈值时发邮件/短信提醒您充值

### **误区4："这样不是所有用户都用我的钱了？"**
💰 **用户已经付过钱了！**  
✅ 用户付¥49 → 您收入¥49 → 您花¥12.5成本 → 利润¥36.5

---

## 📊 监控面板示例

### **管理后台可以看到的数据**

```
┌─────────────────────────────────────┐
│  VivaAPI使用统计                    │
├─────────────────────────────────────┤
│  总充值额度：    ¥1,000             │
│  已使用成本：    ¥230               │
│  剩余额度：      ¥770               │
│  使用率：        23%                │
├─────────────────────────────────────┤
│  本月统计：                         │
│  • 总收入：      ¥1,247             │
│  • VivaAPI成本： ¥230              │
│  • 毛利润：      ¥1,017             │
│  • 利润率：      81.6%              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  用户使用排行                       │
├─────────────────────────────────────┤
│  1. 用户A    已用150积分 (¥37.5)    │
│  2. 用户B    已用120积分 (¥30)      │
│  3. 用户C    已用80积分  (¥20)      │
└─────────────────────────────────────┘
```

---

## 🎬 完整代码流程（简化版）

### **支付成功回调**
```typescript
// 用户付款¥49买50积分
async function handlePayment(userId, packageId) {
  // 1. 充值积分（用户账本）
  await db.query(`
    UPDATE user_credit_accounts 
    SET available_credits = available_credits + 50
    WHERE user_id = $1
  `, [userId])
  
  // 2. 记录配额（运营统计）
  await db.query(`
    INSERT INTO user_viva_api_keys (user_id, quota, used)
    VALUES ($1, 50, 0)
  `, [userId])
}
```

### **视频生成**
```typescript
// 用户生成视频
async function generateVideo(userId, prompt) {
  // 1. 检查积分
  const credits = await getCredits(userId)
  if (credits < 15) throw new Error('积分不足')
  
  // 2. 扣减积分
  await deductCredits(userId, 15)
  
  // 3. 调用VivaAPI（用您的主Token）
  const video = await fetch('https://vivaapi.cn/api/veo3', {
    headers: { 'Authorization': `Bearer ${process.env.VEO_API_KEY}` },
    body: JSON.stringify({ prompt })
  })
  
  // 4. 记录使用量
  await db.query(`
    UPDATE user_viva_api_keys 
    SET used = used + 15 
    WHERE user_id = $1
  `, [userId])
  
  return video
}
```

### **每日统计**
```typescript
// 定时任务：每天统计成本
async function dailyReport() {
  const stats = await db.query(`
    SELECT 
      SUM(used) as total_used,
      SUM(used) * 0.25 as total_cost
    FROM user_viva_api_keys
    WHERE DATE(updated_at) = CURRENT_DATE
  `)
  
  console.log(`今日成本：¥${stats.total_cost}`)
  
  // 如果VivaAPI余额不足，发送告警
  if (vivaApiBalance < 100) {
    sendAlert('VivaAPI余额不足，请充值！')
  }
}
```

---

## ✨ 总结

### **混合模式 = 共享充值卡 + 数据库记账**

1. **您充值VivaAPI** → 买了一张充值卡
2. **用户购买套餐** → 数据库记录积分
3. **用户生成视频** → 用您的充值卡调用API
4. **系统记录使用** → 数据库统计成本
5. **定期补充余额** → 充值卡快用完了再充值

### **您完全不需要担心**：
- ❌ 不需要为每个用户买账号
- ❌ 不需要复杂的分账系统
- ❌ 不需要实时同步VivaAPI

### **您只需要做**：
- ✅ 注册一个VivaAPI账号
- ✅ 充值¥500-1000测试
- ✅ 获取Token配置到系统
- ✅ 每月检查一次余额，快用完了再充值

---

**现在理解了吗？** 😊

就像您开奶茶店一样简单：
- **批发市场 = VivaAPI**（您去买原料）
- **客户 = 用户**（付钱买奶茶）
- **记账本 = 数据库**（记录谁买了多少）
- **做奶茶 = 生成视频**（用原料制作）

是不是很简单？



