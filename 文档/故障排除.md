# 🔧 VEO AI 故障排除指南

## 🚨 常见问题解决方案

### 1. 安装和启动问题

#### 问题：`Port 3000 is already in use`

**原因**：端口3000被其他进程占用

**解决方法**：

**Windows:**
```powershell
# 查找占用端口的进程
netstat -ano | findstr :3000

# 杀死进程（替换<PID>为实际进程ID）
taskkill /PID <PID> /F
```

**Linux/Mac:**
```bash
# 查找并杀死占用端口的进程
lsof -ti:3000 | xargs kill -9
```

---

#### 问题：`npm install` 失败

**原因**：网络问题或依赖冲突

**解决方法**：
```bash
# 清除npm缓存
npm cache clean --force

# 删除node_modules和package-lock.json
rm -rf node_modules package-lock.json

# 重新安装
npm install
```

**使用国内镜像**：
```bash
npm config set registry https://registry.npmmirror.com
npm install
```

---

### 2. 数据库连接问题

#### 问题：`Database connection failed`

**原因**：DATABASE_URL配置错误或数据库服务未启动

**解决方法**：

1. **检查DATABASE_URL格式**：
```env
# 正确格式
DATABASE_URL="postgresql://username:password@host:port/database?sslmode=require"
```

2. **测试数据库连接**：
```bash
# 使用psql测试
psql "postgresql://username:password@host:port/database"
```

3. **检查Supabase连接**：
- 访问 https://supabase.com/dashboard
- 确认项目状态为"Active"
- Database → Connection String → URI
- 使用"Direct connection"而非"Session mode"

---

#### 问题：`relation "users" does not exist`

**原因**：数据库表未创建

**解决方法**：
```sql
-- 运行数据库迁移脚本
-- 检查是否有migration文件，如果有：
psql $DATABASE_URL < migrations/*.sql

-- 或在Supabase Dashboard手动创建表
```

---

### 3. Supabase Storage问题

#### 问题：`Storage bucket not found`

**原因**：Storage bucket未创建

**解决方法**：

**自动创建**（推荐）：
- 系统首次上传文件时会自动创建bucket
- 无需手动操作

**手动创建**：
1. 访问 Supabase Dashboard
2. Storage → Create Bucket
3. 名称：`video-references` 和 `user-avatars`
4. 设置为Public

---

#### 问题：`Upload failed: Unauthorized`

**原因**：SUPABASE_SERVICE_KEY配置错误或权限不足

**解决方法**：

1. **检查Service Key**：
```env
# .env文件
SUPABASE_SERVICE_KEY="eyJh...你的完整service_role密钥"
```

2. **获取正确的Service Key**：
- Supabase Dashboard
- Settings → API
- 复制 "service_role" key（不是anon key）

3. **检查Storage Policy**：
```sql
-- 在Supabase SQL Editor中执行
-- 允许authenticated用户上传
CREATE POLICY "Allow authenticated uploads"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'video-references');
```

---

### 4. 认证问题

#### 问题：`[next-auth][error][JWT_SESSION_ERROR]`

**原因**：NEXTAUTH_SECRET未设置或不一致

**解决方法**：

1. **设置NEXTAUTH_SECRET**：
```env
# .env文件
NEXTAUTH_SECRET="your-super-secret-random-string-32-characters-long"
```

2. **生成随机密钥**：
```bash
# Linux/Mac
openssl rand -base64 32

# Windows PowerShell
[Convert]::ToBase64String((1..32|%{Get-Random -Min 0 -Max 256}))
```

3. **清除浏览器Cookie**：
- Chrome: Ctrl+Shift+Delete
- 选择"Cookie和其他网站数据"
- 清除

---

#### 问题：`登录后立即退出`

**原因**：Session配置问题或Cookie问题

**解决方法**：

1. **检查NEXTAUTH_URL**：
```env
# 开发环境
NEXTAUTH_URL="http://localhost:3000"

# 生产环境
NEXTAUTH_URL="https://your-domain.com"
```

2. **清除所有Cookie和本地存储**

3. **检查环境变量是否生效**：
```bash
# 重启开发服务器
npm run dev
```

---

#### 问题：`微信登录失败：redirect_uri参数错误`

**原因**：微信开放平台回调域名配置错误

**解决方法**：

1. **检查回调域名**：
- 微信开放平台 → 应用详情
- 授权回调域：`https://your-domain.com/api/auth/callback/wechat`

2. **确保使用HTTPS**（生产环境必须）

3. **检查环境变量**：
```env
WECHAT_APP_ID="wx..."
WECHAT_APP_SECRET="..."
```

更多详情请查看 [微信登录配置.md](微信登录配置.md)

---

### 5. 邮件和短信问题

#### 问题：`邮件验证码收不到`

**原因**：未配置Resend API或邮件被拦截

**解决方法**：

1. **开发环境**：
- 验证码会打印在控制台
- 查看终端输出获取验证码

2. **生产环境配置Resend**：
```env
RESEND_API_KEY="re_..."
EMAIL_FROM="VEO AI <noreply@your-domain.com>"
```

3. **检查垃圾邮件文件夹**

4. **验证域名**：
- Resend Dashboard → Domains
- 添加并验证域名

---

#### 问题：`短信发送失败`

**原因**：Twilio配置错误或账户余额不足

**解决方法**：

1. **检查Twilio配置**：
```env
TWILIO_ACCOUNT_SID="AC..."
TWILIO_AUTH_TOKEN="..."
TWILIO_PHONE_NUMBER="+1..."
```

2. **验证账户状态**：
- Twilio Console → Account
- 检查余额和状态

3. **测试号码**：
- 试用账户只能向已验证号码发送
- 添加测试号码到Verified Caller IDs

---

### 6. 视频生成问题

#### 问题：`视频生成失败`

**原因**：积分不足、VEO API错误或网络问题

**解决方法**：

1. **检查积分余额**：
- 访问个人中心
- 确认有足够积分（至少5积分）

2. **检查VEO API配置**：
```env
VEO_API_KEY="sk-..."
```

3. **查看错误日志**：
```bash
# PM2日志
pm2 logs veo-ai

# 开发环境终端输出
```

4. **检查提示词**：
- 避免违规内容
- 描述清晰具体
- 长度在500字符以内

---

#### 问题：`图片上传失败`

**原因**：文件格式、大小或网络问题

**解决方法**：

1. **检查文件要求**：
- 格式：JPG、PNG、WebP
- 大小：每张最大5MB
- 数量：最多6张

2. **压缩图片**：
- 使用在线工具压缩
- 推荐：TinyPNG、Squoosh

3. **检查网络连接**

4. **查看控制台错误**：
- F12 → Console
- 查看详细错误信息

---

#### 问题：`生成速度很慢`

**原因**：服务器负载高或网络延迟

**解决方法**：

1. **正常时间**：30-60秒
2. **高峰期**：可能需要1-2分钟
3. **不要重复提交**：耐心等待
4. **检查网络**：确保连接稳定

---

### 7. 性能问题

#### 问题：`页面加载缓慢`

**原因**：网络延迟或资源过大

**解决方法**：

1. **清除浏览器缓存**

2. **检查网络速度**

3. **禁用浏览器扩展**（可能拦截资源）

4. **使用Chrome开发者工具**：
- F12 → Network
- 查看慢请求

---

#### 问题：`内存占用过高`

**原因**：Node.js内存限制

**解决方法**：

```bash
# 增加Node.js内存限制
NODE_OPTIONS=--max-old-space-size=4096 npm start

# PM2配置
pm2 start npm --name "veo-ai" --node-args="--max-old-space-size=4096" -- start
```

---

### 8. 生产环境问题

#### 问题：`502 Bad Gateway`

**原因**：应用未启动或端口配置错误

**解决方法**：

1. **检查应用状态**：
```bash
pm2 status
pm2 logs veo-ai
```

2. **重启应用**：
```bash
pm2 restart veo-ai
```

3. **检查Nginx配置**：
```nginx
# /etc/nginx/sites-available/veo-ai
location / {
    proxy_pass http://127.0.0.1:3000;  # 确认端口正确
    # ... 其他配置
}
```

---

#### 问题：`HTTPS证书错误`

**原因**：SSL证书过期或配置错误

**解决方法**：

1. **检查证书状态**：
```bash
sudo certbot certificates
```

2. **更新证书**：
```bash
sudo certbot renew
```

3. **强制续期**：
```bash
sudo certbot renew --force-renewal
```

4. **重启Nginx**：
```bash
sudo systemctl restart nginx
```

---

### 9. 数据问题

#### 问题：`积分显示NaN`

**原因**：数据库查询错误或数据格式问题

**解决方法**：

1. **检查数据库数据**：
```sql
-- 查询用户积分
SELECT * FROM user_credit_accounts WHERE user_id = 'your-user-id';
```

2. **修复数据**：
```sql
-- 如果记录不存在，创建
INSERT INTO user_credit_accounts (user_id, available_credits, used_credits)
VALUES ('your-user-id', 10, 0);
```

3. **清除浏览器缓存并重新登录**

---

### 10. 日志和调试

#### 如何查看日志

**开发环境**：
```bash
# 终端直接显示
npm run dev
```

**生产环境（PM2）**：
```bash
# 实时日志
pm2 logs veo-ai

# 错误日志
pm2 logs veo-ai --err

# 最近100行
pm2 logs veo-ai --lines 100
```

**Nginx日志**：
```bash
# 访问日志
tail -f /var/log/nginx/access.log

# 错误日志
tail -f /var/log/nginx/error.log
```

---

#### 调试技巧

1. **浏览器开发者工具**：
   - F12 → Console（查看错误）
   - Network（查看API请求）
   - Application（查看Cookie/Storage）

2. **API测试**：
   ```bash
   # 使用curl测试API
   curl -X POST http://localhost:3000/api/your-endpoint \
     -H "Content-Type: application/json" \
     -d '{"key":"value"}'
   ```

3. **数据库查询**：
   ```bash
   # 连接数据库
   psql $DATABASE_URL
   
   # 查看表结构
   \d users
   
   # 查询数据
   SELECT * FROM users LIMIT 5;
   ```

---

## 📞 仍需帮助？

如果以上方法都无法解决您的问题：

1. **查看完整文档**：
   - [快速开始.md](快速开始.md)
   - [生产环境部署.md](生产环境部署.md)
   - [功能说明.md](功能说明.md)

2. **检查系统状态**：
   ```bash
   # 系统资源
   htop
   df -h
   free -m
   
   # 应用状态
   pm2 status
   systemctl status nginx
   ```

3. **收集错误信息**：
   - 完整的错误消息
   - 浏览器控制台截图
   - 服务器日志
   - 重现步骤

4. **联系支持**：
   - 访问个人中心反馈
   - 发送邮件至支持邮箱
   - 提供详细的错误信息

---

**祝您使用愉快！** 🎉










