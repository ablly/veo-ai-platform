# 💬 VEO AI 微信登录配置指南

## 📋 前提条件

- ✅ 微信开放平台账号
- ✅ 已认证的开发者资质
- ✅ 已备案的域名

---

## 🚀 配置步骤

### 第1步：注册微信开放平台

1. 访问 https://open.weixin.qq.com/
2. 点击"注册"
3. 填写企业/个人信息
4. 完成认证（需要营业执照）

**费用**：
- 个人开发者：免费
- 企业开发者：300元/年认证费

---

### 第2步：创建网站应用

1. 登录微信开放平台
2. 管理中心 → 网站应用 → 创建网站应用

**填写信息**：
- 应用名称：VEO AI 视频生成平台
- 应用简介：基于AI的视频创作平台
- 应用官网：https://你的域名.com
- 应用图标：上传Logo（108x108）

**授权回调域**：
```
https://你的域名.com/api/auth/callback/wechat
```

**注意**：
- 必须使用HTTPS
- 域名必须已备案
- 必须可以正常访问

---

### 第3步：获取AppID和AppSecret

应用创建成功后：

1. 查看应用详情
2. 复制 AppID
3. 复制 AppSecret（点击查看）

**示例**：
```
AppID: wx1234567890abcdef
AppSecret: 1234567890abcdef1234567890abcdef
```

---

### 第4步：配置环境变量

编辑项目的 `.env` 文件：

```env
# 微信登录配置
WECHAT_APP_ID="wx1234567890abcdef"
WECHAT_APP_SECRET="1234567890abcdef1234567890abcdef"
```

---

### 第5步：测试微信登录

1. 重启应用
```bash
pm2 restart veo-ai
```

2. 访问登录页面
3. 点击"微信登录"按钮
4. 扫码登录

**首次登录**：
- 自动创建账号
- 绑定微信OpenID
- 赠送10积分

**再次登录**：
- 自动识别账号
- 更新微信信息
- 直接登录成功

---

## 🔍 验证配置

### 检查环境变量
```bash
# 查看配置
cat .env | grep WECHAT

# 应该输出
WECHAT_APP_ID="wx..."
WECHAT_APP_SECRET="..."
```

### 查看应用日志
```bash
pm2 logs veo-ai
```

**成功日志**：
```
✅ 新用户通过微信注册: 张三, 赠送积分: 10
✅ 用户通过微信登录: 张三
```

**错误日志**：
```
❌ 微信登录处理失败: invalid appid
```

---

## 🚨 常见问题

### 1. 扫码后提示"redirect_uri参数错误"

**原因**：
- 授权回调域配置错误
- 域名未备案
- 使用了HTTP而非HTTPS

**解决方法**：
1. 检查微信开放平台的授权回调域
2. 确保使用 `https://你的域名.com/api/auth/callback/wechat`
3. 确保域名已备案且可访问

---

### 2. 提示"appid不存在"

**原因**：
- AppID填写错误
- 应用未提交审核
- 应用被禁用

**解决方法**：
1. 检查 `.env` 中的 `WECHAT_APP_ID`
2. 确保应用已提交并通过审核
3. 检查应用状态

---

### 3. 扫码后无反应

**原因**：
- AppSecret错误
- 回调域名错误
- 服务器无法访问

**解决方法**：
1. 检查 `.env` 中的 `WECHAT_APP_SECRET`
2. 查看服务器日志
3. 确保服务器可以访问微信API

---

### 4. 登录成功但没有获得积分

**原因**：
- 数据库连接失败
- 积分赠送逻辑错误

**解决方法**：
1. 检查数据库连接
2. 查看服务器日志
3. 手动给用户加积分（临时）

```sql
-- 手动赠送积分
UPDATE user_credit_accounts 
SET available_credits = available_credits + 10 
WHERE user_id = '用户ID';
```

---

## 🔒 安全建议

### 1. 保护AppSecret

**不要**：
- ❌ 提交到Git仓库
- ❌ 在前端代码中暴露
- ❌ 通过HTTP传输

**应该**：
- ✅ 存储在 `.env` 文件
- ✅ 仅在服务器端使用
- ✅ 定期更换

### 2. 验证用户信息

**已实现**：
- ✅ 验证OpenID唯一性
- ✅ 验证UnionID（如果有）
- ✅ 防止重复注册

### 3. 限制回调域名

**设置**：
- ✅ 只设置生产环境域名
- ✅ 不设置通配符域名
- ✅ 使用HTTPS

---

## 📊 微信登录流程

### 用户视角
```
1. 用户点击"微信登录"
   ↓
2. 显示微信二维码
   ↓
3. 用户扫码确认
   ↓
4. 自动登录成功
```

### 技术实现
```
1. 前端调用 signIn("wechat")
   ↓
2. 跳转到微信授权页面
   ↓
3. 用户扫码授权
   ↓
4. 微信回调到 /api/auth/callback/wechat
   ↓
5. 获取code换取access_token
   ↓
6. 获取用户信息（openid, nickname, avatar）
   ↓
7. 查找或创建用户
   ↓
8. 赠送新用户积分
   ↓
9. 创建Session并跳转
```

---

## 📝 数据库存储

### users表字段

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  wechat_openid VARCHAR(128) UNIQUE,    -- 微信OpenID
  wechat_unionid VARCHAR(128),          -- 微信UnionID
  wechat_nickname VARCHAR(128),         -- 微信昵称
  name VARCHAR(128),                    -- 显示名称
  avatar TEXT,                          -- 头像URL
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### 字段说明

- **wechat_openid**: 用户在当前应用的唯一标识
- **wechat_unionid**: 用户在同一开放平台下的唯一标识
- **wechat_nickname**: 微信昵称（自动同步）
- **avatar**: 微信头像（自动同步）

---

## 🎯 最佳实践

### 1. 多账号绑定

**功能**：
- 允许微信账号绑定邮箱
- 允许邮箱账号绑定微信
- 支持多种登录方式

**实现**（待开发）：
```typescript
// 绑定微信到现有账号
const bindWechat = async (userId, openid, unionid) => {
  await updateUser(userId, { 
    wechat_openid: openid,
    wechat_unionid: unionid 
  })
}
```

### 2. 信息同步

**自动同步**：
- 每次登录更新微信昵称
- 每次登录更新微信头像

**代码**：
```typescript
// src/lib/auth.ts signIn callback
await client.query(
  `UPDATE users 
   SET wechat_nickname = $1, avatar = $2, updated_at = NOW() 
   WHERE id = $3`,
  [user.name, user.image, existingUser.id]
)
```

### 3. UnionID使用

**什么是UnionID**：
- 同一开放平台下的唯一标识
- 跨应用识别同一用户

**使用场景**：
- 多个网站/APP共享用户系统
- 统一用户管理

---

## 📞 需要帮助？

**微信开放平台文档**：
https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html

**常见问题**：
查看《故障排除.md》

**技术支持**：
查看应用日志获取详细错误信息

---

**配置完成后，您的用户就可以使用微信快速登录了！** 🎉


