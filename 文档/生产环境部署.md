# 🚀 VEO AI 生产环境部署指南

## 📋 部署前准备

### 1. 服务器要求

**最低配置**：
- CPU: 2核心
- 内存: 4GB
- 存储: 20GB SSD
- 系统: Ubuntu 20.04+ / CentOS 7+

**推荐配置**：
- CPU: 4核心
- 内存: 8GB
- 存储: 50GB SSD

---

### 2. 环境变量配置

创建 `.env` 文件并配置以下变量：

```env
# 数据库配置
DATABASE_URL="postgresql://postgres:密码@host:5432/postgres"

# Supabase配置（必需）
SUPABASE_URL="https://hblthmkkdfkzvpywlthq.supabase.co"
SUPABASE_SERVICE_KEY="你的service_role密钥"

# NextAuth配置
NEXTAUTH_SECRET="生成一个随机密钥"
NEXTAUTH_URL="https://你的域名.com"

# VEO API
VEO_API_KEY="你的VEO_API密钥"

# 邮件服务（可选）
RESEND_API_KEY="你的Resend密钥"
EMAIL_FROM="VEO AI <noreply@你的域名.com>"

# 短信服务（可选）
TWILIO_ACCOUNT_SID="你的Twilio账户"
TWILIO_AUTH_TOKEN="你的Twilio密钥"
TWILIO_PHONE_NUMBER="+1你的号码"

# 微信登录（可选）
WECHAT_APP_ID="你的微信AppID"
WECHAT_APP_SECRET="你的微信密钥"

# 环境
NODE_ENV="production"
```

---

## 🛠️ 部署步骤

### 方法1：使用1Panel（推荐）

#### 步骤1：安装1Panel
```bash
curl -sSL https://resource.fit2cloud.com/1panel/package/quick_start.sh -o quick_start.sh
sudo bash quick_start.sh
```

#### 步骤2：创建网站
1. 登录1Panel面板
2. 网站 → 创建网站
3. 选择 Node.js 环境
4. 配置域名和端口

#### 步骤3：部署项目
```bash
# 上传项目文件到服务器
scp -r veo-ai-platform/ root@服务器IP:/opt/1panel/apps/

# SSH连接服务器
ssh root@服务器IP

# 进入项目目录
cd /opt/1panel/apps/veo-ai-platform

# 安装依赖
npm install --production

# 构建项目
npm run build

# 使用PM2启动
npm install -g pm2
pm2 start npm --name "veo-ai" -- start
pm2 save
pm2 startup
```

#### 步骤4：配置HTTPS
1. 在1Panel中进入网站设置
2. HTTPS → 申请证书
3. 选择 Let's Encrypt
4. 填写域名并申请
5. 开启强制HTTPS

---

### 方法2：手动部署

#### 步骤1：安装Node.js
```bash
# 安装Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo bash -
sudo apt install -y nodejs

# 验证安装
node --version
npm --version
```

#### 步骤2：部署项目
```bash
# 克隆项目
git clone 你的仓库地址
cd veo-ai-platform

# 安装依赖
npm install --production

# 创建.env文件
cp env-template.txt .env
# 编辑.env填入配置

# 构建项目
npm run build

# 启动服务
npm start
```

#### 步骤3：配置进程管理
```bash
# 安装PM2
npm install -g pm2

# 启动应用
pm2 start npm --name "veo-ai" -- start

# 保存配置
pm2 save

# 设置开机自启
pm2 startup
```

#### 步骤4：配置Nginx反向代理
```nginx
server {
    listen 80;
    server_name 你的域名.com;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### 步骤5：配置SSL证书
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d 你的域名.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 🔍 部署检查清单

### 部署前
- [ ] 服务器配置满足要求
- [ ] 域名已解析到服务器IP
- [ ] 环境变量已配置
- [ ] 数据库连接正常
- [ ] Supabase配置正确

### 部署中
- [ ] 项目文件已上传
- [ ] 依赖安装成功
- [ ] 项目构建成功
- [ ] 应用启动正常
- [ ] 端口正常监听

### 部署后
- [ ] 网站可以访问
- [ ] HTTPS证书有效
- [ ] 用户注册登录正常
- [ ] 文件上传功能正常
- [ ] 视频生成功能正常
- [ ] 所有页面响应正常

---

## 📊 性能优化

### 1. 数据库优化
```sql
-- 添加索引
CREATE INDEX IF NOT EXISTS idx_video_user_created 
ON video_generations(user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_credit_user_created 
ON credit_transactions(user_id, created_at DESC);
```

### 2. Nginx优化
```nginx
# 启用Gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript 
           application/javascript application/xml+rss application/json;

# 静态文件缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. PM2集群模式
```bash
# 使用所有CPU核心
pm2 start npm --name "veo-ai" -i max -- start
```

---

## 🔒 安全建议

### 1. 防火墙配置
```bash
# 只开放必要端口
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw enable
```

### 2. 定期备份
```bash
# 备份数据库
pg_dump database_name > backup_$(date +%Y%m%d).sql

# 备份项目文件
tar -czf veo-ai-backup_$(date +%Y%m%d).tar.gz veo-ai-platform/
```

### 3. 监控和日志
```bash
# 查看PM2日志
pm2 logs veo-ai

# 查看Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

---

## 🚨 故障排除

### 应用无法启动
```bash
# 检查日志
pm2 logs veo-ai --err

# 检查端口占用
netstat -tlnp | grep 3000

# 重启应用
pm2 restart veo-ai
```

### HTTPS证书问题
```bash
# 检查证书状态
sudo certbot certificates

# 强制续期
sudo certbot renew --force-renewal
```

### 数据库连接失败
```bash
# 测试数据库连接
psql "postgresql://user:pass@host:5432/db"

# 检查环境变量
echo $DATABASE_URL
```

---

## 📞 技术支持

**常用命令**：
```bash
# 查看应用状态
pm2 status

# 重启应用
pm2 restart veo-ai

# 查看日志
pm2 logs veo-ai

# 查看系统资源
htop
df -h
free -m
```

**需要帮助？**
查看完整文档或检查日志获取详细错误信息。

---

**部署完成后，您的VEO AI平台就可以正式上线了！** 🎉










