# VEO AI 平台 - 运营手册

> **日常运营指南 | Operation Manual**

---

## 📋 目录

1. [管理后台使用](#管理后台使用)
2. [积分兑换码管理](#积分兑换码管理)
3. [订单管理](#订单管理)
4. [用户管理](#用户管理)
5. [内容审核](#内容审核)
6. [数据统计](#数据统计)
7. [客户服务](#客户服务)
8. [常见问题处理](#常见问题处理)

---

## 管理后台使用

### 访问管理后台

**地址**: `https://yourdomain.com/admin/redemption-codes`

**权限**: 需要管理员账号登录

### 主要功能模块

1. **积分兑换码管理** - `/admin/redemption-codes`
2. **订单管理** - 数据库直接查询
3. **用户管理** - 数据库直接查询
4. **数据统计** - 待开发

---

## 积分兑换码管理

### 生成兑换码

**适用场景**：备案前手动销售积分

#### 操作步骤

1. 访问 `/admin/redemption-codes`
2. 点击"生成兑换码"按钮
3. 填写表单：
   - **生成数量**: 1-1000个
   - **积分数量**: 任意正整数
   - **套餐类型**: 选择对应套餐
   - **有效期**: 建议30天
   - **备注**: 记录用途（如：推广活动、赠送等）
4. 点击"生成"
5. 系统自动下载兑换码文件

#### 兑换码格式

```
VEO-ABCD-1234
```

- 前缀：`VEO-`
- 两段4位字符（大写字母+数字）
- 去除易混淆字符（0,O,1,I）

#### 发送给用户

**方式1：直接复制兑换码**
```
您的兑换码：VEO-ABCD-1234
有效期：30天
请访问 https://yourdomain.com/redeem 兑换
```

**方式2：批量导出**
- 下载生成的txt文件
- 通过邮件/微信发送

### 查看兑换码状态

#### 状态说明

| 状态 | 说明 | 颜色 |
|------|------|------|
| ACTIVE | 可用 | 绿色 |
| REDEEMED | 已兑换 | 灰色 |
| EXPIRED | 已过期 | 橙色 |
| VOIDED | 已作废 | 红色 |

#### 筛选功能

- **全部**: 查看所有兑换码
- **可用**: 未使用的兑换码
- **已兑换**: 查看谁使用了
- **已过期**: 可以删除
- **已作废**: 手动作废的

### 作废兑换码

**场景**: 发错兑换码、用户退款等

**操作**: 
1. 找到对应兑换码
2. 点击右侧"作废"图标
3. 确认作废
4. ⚠️ 此操作不可撤销

---

## 订单管理

### 查询订单

#### 使用SQL查询（数据库管理工具）

```sql
-- 查看最近订单
SELECT 
  order_number, 
  package_name, 
  amount, 
  status,
  created_at,
  paid_at
FROM credit_orders
ORDER BY created_at DESC
LIMIT 50;

-- 查询特定用户的订单
SELECT * FROM credit_orders
WHERE user_id = 'user_id_here'
ORDER BY created_at DESC;

-- 统计今日订单
SELECT 
  COUNT(*) as total_orders,
  SUM(amount) as total_amount,
  SUM(CASE WHEN status = 'PAID' THEN amount ELSE 0 END) as paid_amount
FROM credit_orders
WHERE DATE(created_at) = CURRENT_DATE;
```

### 订单状态

| 状态 | 说明 | 操作 |
|------|------|------|
| PENDING | 待支付 | 等待用户支付 |
| PAID | 已支付 | 已完成积分充值 |
| CANCELLED | 已取消 | 超时自动取消 |
| REFUNDED | 已退款 | 需要扣除积分 |

### 手动处理订单

#### 场景1：支付成功但积分未到账

```sql
-- 查询订单
SELECT * FROM credit_orders WHERE order_number = 'VEO1234567890';

-- 手动给用户充值
INSERT INTO credit_transactions (
  user_id, type, amount, description, 
  balance_before, balance_after, created_at
) VALUES (
  'user_id_here',
  'MANUAL_CREDIT',
  50,
  '手动补充积分 - 订单VEO1234567890',
  (SELECT available_credits FROM user_credit_accounts WHERE user_id = 'user_id_here'),
  (SELECT available_credits FROM user_credit_accounts WHERE user_id = 'user_id_here') + 50,
  NOW()
);

-- 更新积分账户
UPDATE user_credit_accounts
SET available_credits = available_credits + 50,
    total_credits = total_credits + 50
WHERE user_id = 'user_id_here';
```

#### 场景2：退款处理

**使用退款API**:
```bash
curl -X POST https://yourdomain.com/api/payment/alipay/refund \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "order_uuid_here",
    "refundReason": "用户申请退款"
  }'
```

**手动退款**（仅在API失败时使用）:
```sql
-- 1. 扣除用户积分
UPDATE user_credit_accounts
SET available_credits = available_credits - 50
WHERE user_id = 'user_id_here';

-- 2. 更新订单状态
UPDATE credit_orders
SET refund_status = 'REFUNDED',
    refund_at = NOW(),
    refund_reason = '手动退款'
WHERE id = 'order_uuid_here';

-- 3. 记录交易
INSERT INTO credit_transactions (...)
```

---

## 用户管理

### 查看用户信息

```sql
-- 查询用户基本信息
SELECT 
  u.id,
  u.email,
  u.name,
  u.created_at,
  uca.available_credits,
  uca.total_credits,
  uca.used_credits
FROM users u
LEFT JOIN user_credit_accounts uca ON u.id = uca.user_id
ORDER BY u.created_at DESC
LIMIT 50;

-- 查询活跃用户（最近7天有生成视频）
SELECT DISTINCT u.email, u.name, COUNT(vg.id) as video_count
FROM users u
JOIN video_generations vg ON u.id = vg.user_id
WHERE vg.created_at > NOW() - INTERVAL '7 days'
GROUP BY u.id, u.email, u.name
ORDER BY video_count DESC;
```

### 手动给用户充值积分

```sql
-- 充值50积分
UPDATE user_credit_accounts
SET available_credits = available_credits + 50,
    total_credits = total_credits + 50
WHERE user_id = 'user_id_here';

-- 记录交易
INSERT INTO credit_transactions (
  user_id, type, amount, description,
  balance_before, balance_after, created_at
) VALUES (
  'user_id_here',
  'MANUAL_CREDIT',
  50,
  '管理员手动充值',
  (SELECT available_credits FROM user_credit_accounts WHERE user_id = 'user_id_here') - 50,
  (SELECT available_credits FROM user_credit_accounts WHERE user_id = 'user_id_here'),
  NOW()
);
```

### 封禁用户（如有滥用）

```sql
-- 禁用用户账户（需要先添加is_active字段）
-- ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT true;

UPDATE users
SET is_active = false
WHERE email = 'abuser@example.com';
```

---

## 内容审核

### 审核用户生成的视频

```sql
-- 查看最新生成的视频
SELECT 
  vg.id,
  u.email,
  vg.prompt,
  vg.status,
  vg.video_url,
  vg.created_at
FROM video_generations vg
JOIN users u ON vg.user_id = u.id
ORDER BY vg.created_at DESC
LIMIT 50;

-- 查找可疑内容（包含关键词）
SELECT * FROM video_generations
WHERE prompt ILIKE '%敏感词%'
ORDER BY created_at DESC;
```

### 删除违规内容

```sql
-- 删除视频记录
DELETE FROM video_generations
WHERE id = 'video_id_here';

-- 如果在展示廊，也删除
DELETE FROM gallery_videos
WHERE generation_id = 'video_id_here';
```

---

## 数据统计

### 每日数据

```sql
-- 今日注册用户
SELECT COUNT(*) FROM users
WHERE DATE(created_at) = CURRENT_DATE;

-- 今日订单和收入
SELECT 
  COUNT(*) as order_count,
  SUM(CASE WHEN status = 'PAID' THEN amount ELSE 0 END) as revenue
FROM credit_orders
WHERE DATE(created_at) = CURRENT_DATE;

-- 今日视频生成量
SELECT COUNT(*) FROM video_generations
WHERE DATE(created_at) = CURRENT_DATE;
```

### 月度数据

```sql
-- 本月收入
SELECT 
  DATE(created_at) as date,
  COUNT(*) as orders,
  SUM(amount) as revenue
FROM credit_orders
WHERE status = 'PAID'
AND created_at >= DATE_TRUNC('month', CURRENT_DATE)
GROUP BY DATE(created_at)
ORDER BY date;

-- 本月活跃用户
SELECT COUNT(DISTINCT user_id) as active_users
FROM video_generations
WHERE created_at >= DATE_TRUNC('month', CURRENT_DATE);
```

### 套餐销售统计

```sql
-- 套餐销售排行
SELECT 
  package_name,
  COUNT(*) as sales,
  SUM(amount) as revenue
FROM credit_orders
WHERE status = 'PAID'
GROUP BY package_name
ORDER BY sales DESC;
```

---

## 客户服务

### 常见问题

#### 1. 用户反馈：积分未到账

**检查步骤**:
```sql
-- 1. 查询订单
SELECT * FROM credit_orders
WHERE user_id = (SELECT id FROM users WHERE email = 'user@example.com')
ORDER BY created_at DESC;

-- 2. 查询积分账户
SELECT * FROM user_credit_accounts
WHERE user_id = (SELECT id FROM users WHERE email = 'user@example.com');

-- 3. 查询交易记录
SELECT * FROM credit_transactions
WHERE user_id = (SELECT id FROM users WHERE email = 'user@example.com')
ORDER BY created_at DESC;
```

**解决方案**:
- 如果订单已支付但未充值 → 手动充值
- 如果订单未支付 → 提醒用户完成支付
- 如果支付宝已扣款但订单未更新 → 联系技术处理

#### 2. 用户反馈：兑换码无效

**检查**:
```sql
SELECT * FROM redemption_codes
WHERE code = 'VEO-ABCD-1234';
```

**常见原因**:
- 已被兑换 (status = 'REDEEMED')
- 已过期 (expires_at < NOW())
- 已作废 (status = 'VOIDED')
- 输入错误（区分大小写）

#### 3. 用户反馈：视频生成失败

**检查**:
```sql
SELECT * FROM video_generations
WHERE user_id = (SELECT id FROM users WHERE email = 'user@example.com')
ORDER BY created_at DESC
LIMIT 5;
```

**常见原因**:
- VEO API错误 → 查看日志
- 积分已扣除但视频未生成 → 手动退回积分
- 参考图片格式不支持 → 提示用户

---

## 常见问题处理

### 问题1：服务器CPU/内存过高

```bash
# 查看进程
pm2 list

# 查看系统资源
htop

# 重启应用
pm2 restart veo-ai-platform

# 如果仍然高，可能需要扩容
```

### 问题2：数据库连接数过多

```sql
-- 查看当前连接
SELECT COUNT(*) FROM pg_stat_activity;

-- 杀死空闲连接
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'idle'
AND state_change < NOW() - INTERVAL '10 minutes';
```

### 问题3：支付回调失败

```bash
# 查看支付回调日志
tail -f /var/log/veo/out.log | grep "payment"

# 手动触发订单检查
# （需要开发对应的管理API）
```

### 问题4：Nginx 502错误

```bash
# 检查应用状态
pm2 status

# 重启应用
pm2 restart veo-ai-platform

# 检查Nginx
sudo nginx -t
sudo systemctl restart nginx
```

---

## 数据备份和恢复

### 手动备份

```bash
# 备份数据库
pg_dump -U veo_user veo_production > backup_$(date +%Y%m%d).sql

# 压缩备份
gzip backup_$(date +%Y%m%d).sql
```

### 恢复数据库

```bash
# 解压备份
gunzip backup_20240101.sql.gz

# 恢复
psql -U veo_user veo_production < backup_20240101.sql
```

---

## 紧急联系方式

**技术支持**: 
- 邮箱: support@yourdomain.com
- 电话: xxx-xxxx-xxxx

**服务器提供商**:
- 阿里云/腾讯云/AWS 控制台

**数据库**:
- Supabase Dashboard: https://app.supabase.com

---

## 日常检查清单

### 每日检查（5分钟）

- [ ] 查看PM2状态
- [ ] 查看错误日志
- [ ] 查看今日订单和收入
- [ ] 查看今日新增用户
- [ ] 查看服务器资源使用率

### 每周检查（30分钟）

- [ ] 审核用户生成的视频
- [ ] 清理过期订单
- [ ] 查看数据库慢查询
- [ ] 检查备份是否正常
- [ ] 更新系统和依赖

### 每月检查（1小时）

- [ ] 数据统计分析
- [ ] 用户反馈整理
- [ ] 优化建议收集
- [ ] 成本核算
- [ ] 备份测试恢复

---

**运营愉快！** 如有问题，请随时查阅本手册或联系技术支持。



