# 🔍 数据库实时验证使用指南

## 📋 概述

这个验证脚本可以帮助您实时查看数据库中的数据变化，特别适合用于：
- ✅ 验证注册功能是否正常
- ✅ 验证登录功能是否正常
- ✅ 观察积分系统的实时更新
- ✅ 检查验证码的生成和使用
- ✅ 监控用户数据的变化

---

## 🚀 使用方法

### 运行验证脚本

```bash
node verify-db-realtime.js
```

---

## 📊 当前数据库状态

根据最新验证结果，您的数据库状态如下：

### 👥 **用户数据** (2个用户)

#### 1. 用户 - noiseyk2@gmail.com
```
📧 邮箱: noiseyk2@gmail.com
👤 姓名: 周启航
💰 可用积分: 12
📅 注册时间: 2025/10/20 15:12:12
✅ 状态: active
```

#### 2. 用户 - 3533912007@qq.com (管理员)
```
📧 邮箱: 3533912007@qq.com
👤 姓名: 周启航
💰 可用积分: 100
📱 手机: 17531773038
📅 注册时间: 2025/10/20 14:54:34
✅ 状态: active
```

### 💎 **积分统计**

```
总可用积分: 112
总已用积分: 75
总交易记录: 4
```

### 📜 **交易历史**

1. **购买专业套餐** - 2025/10/22
   - 用户: 3533912007@qq.com
   - 积分: +150
   
2. **购买体验套餐** - 2025/10/20
   - 用户: 3533912007@qq.com
   - 积分: +10

3. **新用户注册** - 2025/10/20
   - 用户: noiseyk2@gmail.com
   - 积分: +10 (赠送)

4. **新用户注册** - 2025/10/20
   - 用户: 3533912007@qq.com
   - 积分: +10 (赠送)

### 🔐 **验证码状态**

```
有效验证码: 1
最新验证码: 885003 (3533912007@qq.com)
过期时间: 2025/10/26 23:56:39
```

---

## 🧪 测试流程

### 测试1: 新用户注册

**步骤**：
1. 运行验证脚本，记录当前用户数
2. 访问 http://localhost:3000/register
3. 填写注册信息并提交
4. 再次运行验证脚本

**预期结果**：
```
✅ 用户数 +1
✅ 新增积分账户
✅ 新增积分交易记录 (BONUS: +10)
✅ 总可用积分增加 10
```

---

### 测试2: 邮箱验证码登录

**步骤**：
1. 运行验证脚本
2. 访问 http://localhost:3000/login
3. 选择"验证码登录"
4. 输入邮箱，点击"获取验证码"
5. 运行验证脚本，查看新增的验证码
6. 输入验证码登录
7. 再次运行验证脚本

**预期结果**：
```
✅ 新增验证码记录 (状态: 有效)
✅ 登录后验证码状态变为"已使用"
✅ 有效验证码数量变化
```

---

### 测试3: 账户密码登录

**步骤**：
1. 访问 http://localhost:3000/login
2. 选择"账户登录"
3. 输入邮箱和密码
4. 点击登录

**预期结果**：
```
✅ 登录成功
✅ 跳转到首页
✅ 显示用户信息
✅ 数据库中用户updated_at时间更新
```

---

### 测试4: 积分购买

**步骤**：
1. 运行验证脚本，记录当前积分
2. 登录后访问定价页面购买积分
3. 完成支付（测试环境）
4. 再次运行验证脚本

**预期结果**：
```
✅ 积分账户余额增加
✅ 新增交易记录 (PURCHASE)
✅ balance_before 和 balance_after 正确
✅ 总可用积分增加
```

---

## 📈 数据验证要点

### ✅ **用户数据验证**

```javascript
// 检查点：
1. 新用户注册后立即出现在users表
2. email字段唯一且正确
3. password已加密（不是明文）
4. created_at和updated_at时间正确
5. 默认status为active
```

### ✅ **积分账户验证**

```javascript
// 检查点：
1. 注册时自动创建积分账户
2. 新用户获得10积分奖励
3. available_credits = total_credits - used_credits - frozen_credits
4. 积分变动时updated_at更新
```

### ✅ **交易记录验证**

```javascript
// 检查点：
1. 每次积分变动都有交易记录
2. balance_before + credit_amount = balance_after
3. transaction_type正确 (BONUS/PURCHASE/DEDUCT)
4. description清晰描述交易原因
```

### ✅ **验证码验证**

```javascript
// 检查点：
1. 验证码为6位数字
2. expires_at = created_at + 10分钟
3. 使用后used变为true
4. 过期的验证码不能使用
```

---

## 🔧 脚本功能说明

### 显示的数据表

1. **users** - 用户基本信息
2. **user_credit_accounts** - 积分账户
3. **credit_transactions** - 积分交易记录
4. **email_verification_codes** - 邮箱验证码

### 统计信息

```
👥 总用户数
💬 微信绑定用户数
💳 积分账户数
💎 总可用积分
📊 总已用积分
📜 总交易记录
🔐 有效验证码数
```

---

## 🎯 常见问题

### Q1: 验证码状态显示"已过期"？

**原因**：验证码有效期为10分钟

**解决**：重新获取验证码即可

---

### Q2: 积分数据不一致？

**检查项**：
```
1. available_credits = total_credits - used_credits - frozen_credits
2. 查看credit_transactions中的balance_before和balance_after
3. 确认没有未记录的交易
```

---

### Q3: 新注册用户没有积分？

**检查项**：
```
1. 查看user_credit_accounts表是否有对应记录
2. 查看credit_transactions是否有BONUS记录
3. 检查注册API的事务处理
```

---

## 📝 测试检查清单

### 注册功能测试

```
□ 邮箱注册成功
□ 用户数据正确写入
□ 自动创建积分账户
□ 获得10积分奖励
□ 交易记录正确
□ 邮箱格式验证
□ 密码加密存储
□ 重复邮箱拒绝
```

### 登录功能测试

```
□ 账户密码登录成功
□ 验证码登录成功
□ 错误密码被拒绝
□ 错误验证码被拒绝
□ 过期验证码被拒绝
□ 登录后跳转正确
□ 会话状态正确
□ 用户信息显示正确
```

### 积分系统测试

```
□ 积分余额显示正确
□ 购买积分成功
□ 积分扣除正确
□ 交易记录完整
□ 余额计算正确
□ 冻结积分功能正常
```

---

## 🎉 验证成功标志

当您看到以下结果时，说明系统运行正常：

```
✅ 用户数据实时更新
✅ 积分账户同步创建
✅ 交易记录完整准确
✅ 验证码正常生成和使用
✅ 数据一致性保持
✅ 时间戳正确更新
```

---

## 💡 使用提示

1. **测试前先运行一次**
   - 了解当前数据库状态
   - 记录基准数据

2. **每次操作后都验证**
   - 注册后验证
   - 登录后验证
   - 购买后验证

3. **对比前后数据变化**
   - 用户数是否增加
   - 积分是否正确
   - 交易记录是否生成

4. **检查异常数据**
   - 过期但未使用的验证码
   - 积分计算不一致
   - 缺失的交易记录

---

**🔍 保持此脚本在开发期间使用，确保数据库数据的实时准确性！**







