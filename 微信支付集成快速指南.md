# 💳 微信支付集成 - 快速开始指南

## 🎯 5步完成微信支付集成

### 步骤1：申请微信支付商户号（3-7个工作日）

#### 1.1 准备材料
- ✅ 营业执照
- ✅ 法人身份证
- ✅ 对公银行账户信息
- ✅ 店铺照片
- ✅ 公司公章

#### 1.2 注册流程
1. 访问：https://pay.weixin.qq.com
2. 点击"立即注册" → "商家" → "企业/个体工商户"
3. 填写基本信息
4. 提交资质材料
5. 等待审核（3-7个工作日）
6. 签订协议
7. 开始使用

#### 1.3 获取配置信息

登录商户平台后，获取以下信息：

**商户号（MchID）**:
- 路径：账户中心 → 商户信息
- 示例：`1234567890`

**APIv3密钥**:
- 路径：账户中心 → API安全 → 设置APIv3密钥
- 格式：32位字符串
- ⚠️ 请妥善保管！

**商户证书**:
- 路径：账户中心 → API安全 → 申请API证书
- 下载：`apiclient_cert.pem`（证书）和 `apiclient_key.pem`（私钥）
- 证书序列号：在证书管理页面可以看到

---

### 步骤2：安装依赖并配置环境

#### 2.1 安装npm包

```bash
cd veo-ai-platform
npm install wechatpay-node-v3 qrcode.react
```

#### 2.2 配置环境变量

编辑 `.env` 文件：

```env
# 微信支付配置
WECHAT_MCH_ID="1234567890"
WECHAT_SERIAL_NO="5F2E8A1B3C4D5E6F7A8B9C0D1E2F3A4B5C6D7E8F"
WECHAT_APIV3_KEY="your_apiv3_key_32_characters_long"

# 商户私钥（从apiclient_key.pem读取）
WECHAT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
...完整的私钥内容...
-----END PRIVATE KEY-----"
```

**⚠️ 如何获取私钥内容**:

```bash
# 1. 打开apiclient_key.pem文件
cat apiclient_key.pem

# 2. 复制全部内容，包括开始和结束标记
# 3. 粘贴到.env文件，保持格式

# Windows PowerShell:
Get-Content apiclient_key.pem | Out-String
```

---

### 步骤3：创建支付API

#### 文件位置：`src/app/api/payment/`

我已经在**商业化运营完整方案.md**中提供了完整的代码，包括：

- `create-order/route.ts` - 创建支付订单
- `notify/route.ts` - 处理支付回调
- `check-status/route.ts` - 查询订单状态

复制代码到对应文件即可。

---

### 步骤4：更新前端支付界面

#### 4.1 安装QR码组件

```bash
npm install qrcode.react
```

#### 4.2 更新积分页面

文件：`src/app/credits/page.tsx`

添加以下功能：

```tsx
import { QRCodeSVG } from 'qrcode.react'
import { useState } from 'react'

// 支付状态
const [showPaymentModal, setShowPaymentModal] = useState(false)
const [paymentQrCode, setPaymentQrCode] = useState('')
const [currentOrder, setCurrentOrder] = useState<any>(null)

// 购买处理
const handlePurchase = async (packageId: string) => {
  try {
    const response = await fetch('/api/payment/create-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ packageId })
    })

    const data = await response.json()

    if (data.success) {
      setPaymentQrCode(data.qrCode)
      setCurrentOrder(data)
      setShowPaymentModal(true)
      
      // 开始轮询订单状态
      pollOrderStatus(data.orderId)
    } else {
      alert('创建订单失败：' + data.error)
    }
  } catch (error) {
    alert('创建订单失败')
  }
}

// 轮询订单状态
const pollOrderStatus = (orderId: string) => {
  const interval = setInterval(async () => {
    try {
      const response = await fetch(`/api/payment/check-status?orderId=${orderId}`)
      const data = await response.json()

      if (data.status === 'PAID') {
        clearInterval(interval)
        setShowPaymentModal(false)
        alert(`✅ 支付成功！${data.credits}积分已到账`)
        fetchCreditsData() // 刷新积分
      } else if (data.status === 'CANCELLED' || data.status === 'REFUNDED') {
        clearInterval(interval)
        setShowPaymentModal(false)
        alert('订单已取消')
      }
    } catch (error) {
      console.error('查询订单状态失败', error)
    }
  }, 2000) // 每2秒查询一次

  // 5分钟后停止轮询
  setTimeout(() => {
    clearInterval(interval)
    if (showPaymentModal) {
      setShowPaymentModal(false)
      alert('支付超时，请重新购买')
    }
  }, 300000)
}

// 在JSX中添加支付弹窗
return (
  <>
    {/* 原有内容 */}
    
    {/* 支付二维码弹窗 */}
    {showPaymentModal && (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <motion.div
          initial={{ opacity: 0, scale: 0.9 }}
          animate={{ opacity: 1, scale: 1 }}
          className="bg-white rounded-2xl p-8 max-w-md mx-4"
        >
          <h3 className="text-2xl font-bold mb-4 text-center">微信扫码支付</h3>
          
          <div className="bg-gray-50 rounded-lg p-4 mb-4">
            <div className="text-center mb-2">
              <span className="text-gray-600">套餐：</span>
              <span className="font-bold">{currentOrder?.packageName}</span>
            </div>
            <div className="text-center mb-2">
              <span className="text-gray-600">积分：</span>
              <span className="font-bold text-yellow-500">{currentOrder?.credits}</span>
            </div>
            <div className="text-center">
              <span className="text-gray-600">金额：</span>
              <span className="font-bold text-2xl text-red-500">¥{currentOrder?.amount}</span>
            </div>
          </div>

          <div className="flex justify-center mb-4 bg-white p-4 rounded-lg border-2 border-gray-200">
            <QRCodeSVG 
              value={paymentQrCode} 
              size={256}
              level="H"
              includeMargin={true}
            />
          </div>
          
          <div className="text-center text-gray-600 mb-4">
            <p className="mb-2">📱 请使用微信扫描二维码完成支付</p>
            <p className="text-sm text-gray-500">支付成功后会自动跳转</p>
          </div>

          <div className="flex gap-2">
            <Button 
              onClick={() => setShowPaymentModal(false)} 
              variant="outline"
              className="flex-1"
            >
              取消支付
            </Button>
            <Button 
              onClick={() => pollOrderStatus(currentOrder.orderId)}
              className="flex-1 bg-green-500 hover:bg-green-600"
            >
              已完成支付
            </Button>
          </div>
        </motion.div>
      </div>
    )}
  </>
)
```

#### 4.3 更新套餐卡片

```tsx
<Button
  onClick={() => handlePurchase(pkg.id)}
  className="w-full bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600"
>
  立即购买
</Button>
```

---

### 步骤5：创建订单状态查询API

#### 文件：`src/app/api/payment/check-status/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server"
import { getServerSession } from "next-auth/next"
import { authOptions } from "@/lib/auth"
import { pool } from "@/lib/db"

export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions)
    if (!session?.user?.email) {
      return NextResponse.json({ error: "未登录" }, { status: 401 })
    }

    const { searchParams } = new URL(request.url)
    const orderId = searchParams.get('orderId')

    if (!orderId) {
      return NextResponse.json({ error: "缺少orderId" }, { status: 400 })
    }

    // 查询订单状态
    const result = await pool.query(
      `SELECT o.status, o.credits, o.amount, o.package_name, o.paid_at
       FROM orders o
       JOIN users u ON o.user_id = u.id
       WHERE o.id = $1 AND u.email = $2`,
      [orderId, session.user.email]
    )

    if (result.rows.length === 0) {
      return NextResponse.json({ error: "订单不存在" }, { status: 404 })
    }

    const order = result.rows[0]

    return NextResponse.json({
      success: true,
      status: order.status,
      credits: order.credits,
      amount: order.amount,
      packageName: order.package_name,
      paidAt: order.paid_at
    })

  } catch (error) {
    console.error('查询订单状态失败:', error)
    return NextResponse.json({ error: "查询失败" }, { status: 500 })
  }
}
```

---

## 🧪 测试流程

### 1. 本地测试准备

#### 使用ngrok暴露本地服务

```bash
# 安装ngrok
npm install -g ngrok

# 启动本地服务
npm run dev

# 在新终端暴露3000端口
ngrok http 3000

# 你会得到一个公网URL，如：
# https://abc123.ngrok.io
```

#### 配置微信支付回调地址

在微信支付商户平台：
1. 产品中心 → 开发配置
2. 添加回调地址：`https://abc123.ngrok.io/api/payment/notify`

### 2. 测试支付流程

1. **访问网站**：`https://abc123.ngrok.io`
2. **登录账号**（使用测试账号）
3. **进入积分页面**：`/credits`
4. **选择最小套餐**（¥9.9）
5. **点击购买**
6. **使用微信扫码支付**（真实支付，建议小额测试）
7. **等待支付成功**
8. **验证积分到账**

### 3. 验证检查点

- [ ] 二维码正常显示
- [ ] 微信扫码可以打开支付页面
- [ ] 支付成功后收到回调
- [ ] 订单状态更新为PAID
- [ ] 用户积分正确增加
- [ ] 前端自动刷新显示新积分

---

## 🚨 常见问题

### Q1: 获取不到商户证书序列号？

**解决方案**:
```bash
# 使用OpenSSL查看证书序列号
openssl x509 -in apiclient_cert.pem -noout -serial

# 输出示例：
# serial=5F2E8A1B3C4D5E6F7A8B9C0D1E2F3A4B5C6D7E8F
```

### Q2: 私钥格式错误？

**解决方案**:
```env
# 确保私钥包含完整的开始和结束标记
WECHAT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
第1行内容
第2行内容
...
最后1行内容
-----END PRIVATE KEY-----"

# 注意：
# 1. 保持换行符
# 2. 不要有多余空格
# 3. 开始和结束标记必须完整
```

### Q3: 支付回调收不到？

**检查清单**:
- [ ] 回调URL是否配置正确（微信商户平台）
- [ ] URL是否可公网访问（ngrok或服务器）
- [ ] URL必须是HTTPS
- [ ] 检查服务器日志

### Q4: 签名验证失败？

**解决方案**:
1. 确认APIv3密钥正确
2. 确认证书序列号正确
3. 检查系统时间是否准确
4. 查看微信支付开发文档

### Q5: 生产环境部署？

**步骤**:
1. 部署网站到服务器（需要HTTPS）
2. 更新`.env`中的`NEXTAUTH_URL`
3. 在微信商户平台更新回调地址
4. 测试支付流程
5. 正式上线

---

## 📊 支付流程监控

### 创建监控脚本

```typescript
// scripts/monitor-payments.ts
import { pool } from './lib/db'

async function monitorPayments() {
  const result = await pool.query(`
    SELECT 
      DATE(created_at) as date,
      COUNT(*) as total_orders,
      SUM(CASE WHEN status = 'PAID' THEN 1 ELSE 0 END) as paid_orders,
      SUM(CASE WHEN status = 'PENDING' THEN 1 ELSE 0 END) as pending_orders,
      SUM(CASE WHEN status = 'PAID' THEN amount ELSE 0 END) as total_revenue
    FROM orders
    WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'
    GROUP BY DATE(created_at)
    ORDER BY date DESC
  `)

  console.log('📊 最近7天支付统计:')
  result.rows.forEach(row => {
    console.log(`
      日期: ${row.date}
      总订单: ${row.total_orders}
      已支付: ${row.paid_orders}
      待支付: ${row.pending_orders}
      收入: ¥${row.total_revenue}
    `)
  })
}

monitorPayments()
```

---

## ✅ 部署检查清单

### 上线前必检项

#### 技术配置
- [ ] 微信支付商户号已开通
- [ ] 获取所有必需的密钥和证书
- [ ] 环境变量配置完整
- [ ] 代码已部署到生产环境
- [ ] HTTPS证书已配置
- [ ] 回调地址已在微信平台配置

#### 功能测试
- [ ] 微信登录正常
- [ ] 支付下单成功
- [ ] 二维码正常显示
- [ ] 支付回调正常
- [ ] 积分正确到账
- [ ] 订单状态同步

#### 安全检查
- [ ] 私钥未提交到Git
- [ ] 签名验证正常
- [ ] 订单防重放
- [ ] 金额校验正常
- [ ] 错误日志记录

#### 运营准备
- [ ] 套餐价格已确定
- [ ] 客服联系方式
- [ ] 退款流程确定
- [ ] 监控告警配置

---

## 🎉 恭喜！

完成以上步骤后，您的VEO AI平台就拥有了完整的微信支付功能！

**下一步**:
1. 集成VivaAPI（参考《商业化运营完整方案.md》）
2. 完善用户体验
3. 开始推广运营
4. 赚取收益！💰

---

**祝您商业化运营成功！** 🚀

如有问题，欢迎随时咨询！



